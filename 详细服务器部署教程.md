# 🔧 LuckyMart TJ 服务器部署完整教程

## 📋 部署前准备

### 信息确认
- **服务器IP:** 47.243.83.253
- **登录用户:** root
- **项目路径:** /var/www/luckymart-tj
- **GitHub仓库:** https://github.com/reportyao/luckymart-tj

---

## 🚀 步骤一：连接到服务器

### 方法1：使用MySQL Workbench连接
1. 打开MySQL Workbench
2. 点击"Database" → "Manage Connections"
3. 点击"New"创建新连接
4. 填写以下信息：
   ```
   Connection Name: LuckyMart-Server
   Hostname: 47.243.83.253
   Port: 22
   Username: root
   Password: (您的服务器密码)
   ```
5. 点击"Test Connection"测试连接
6. 连接成功后，界面底部会出现终端窗口

### 方法2：使用SSH终端
如果您有SSH终端工具，可以直接连接：
```bash
ssh root@47.243.83.253
```

---

## 🔍 步骤二：检查服务器状态

### 2.1 检查当前目录
在终端中输入以下命令并按回车：
```bash
pwd
```
**预期结果：** 应该显示 `/root` 或类似路径

### 2.2 检查项目目录是否存在
```bash
ls -la /var/www/
```
**预期结果：** 应该看到 `luckymart-tj` 目录

### 2.3 进入项目目录
```bash
cd /var/www/luckymart-tj
```
**确认：** 输入 `pwd` 应该显示 `/var/www/luckymart-tj`

---

## 💾 步骤三：备份当前版本（重要！）

### 3.1 创建备份目录
```bash
BACKUP_DIR="/var/backups/luckymart-tj-$(date +%Y%m%d-%H%M%S)"
```
然后按回车

### 3.2 执行备份命令
```bash
mkdir -p $BACKUP_DIR && cp -r /var/www/luckymart-tj/* $BACKUP_DIR/ 2>/dev/null || true
```
按回车后应该看到类似：
```
✅ 备份完成: /var/backups/luckymart-tj-20251030-183604
```

---

## 📥 步骤四：拉取最新代码

### 4.1 拉取GitHub代码
```bash
git pull origin main
```
**等待过程：** 这个命令会从GitHub下载最新代码，大约需要1-3分钟

**成功信号：** 看到类似信息：
```
Already up to date.
```
或
```
Updating a84c45a..9cc3ce6
   77 files changed, 13131 insertions(+), 697 deletions(-)
```

---

## 🔧 步骤五：安装依赖

### 5.1 安装Node.js依赖
```bash
npm install
```
**等待过程：** 这个命令会下载所有必需的Node.js包，可能需要5-10分钟

**成功信号：** 最后看到类似：
```
added XXX packages in XXs
```

---

## 🗄️ 步骤六：数据库迁移

### 6.1 生成Prisma客户端
```bash
npx prisma generate
```
**成功信号：** 看到类似：
```
Prisma Client generated successfully
```

### 6.2 更新数据库Schema
```bash
npx prisma db push
```
**成功信号：** 看到类似：
```
✅ Your database is now in sync with your Prisma schema
```

---

## ⚡ 步骤七：构建项目

### 7.1 编译生产版本
```bash
npm run build
```
**等待过程：** 这个命令会编译Next.js项目，大约需要2-5分钟

**成功信号：** 最后看到：
```
Route (app)                                Size     First Load JS
┌ ○ /                                     1.3 kB         85.2 kB
├ ○ /_not-found                          882 B          67.1 kB
...
+○ [Static]                              9.49 kB        95.2 kB
✓ Built in X.XXs
```

---

## 🔄 步骤八：重启服务

### 8.1 重启LuckyMart服务
```bash
pm2 restart luckymart-tj || pm2 start npm --name "luckymart-tj" -- start
```

**成功信号：** 看到类似：
```
[PM2] Applying action restartProcessId on app luckymart-tj
[PM2] ✓ Process successfully restarted
```

---

## 📊 步骤九：验证部署结果

### 9.1 检查服务状态
```bash
pm2 status
```
**成功信号：** 应该看到 `luckymart-tj` 状态为 `online`

### 9.2 检查网站访问
```bash
curl -f http://localhost:3000/health
```
**成功信号：** 返回200 OK

---

## ✅ 步骤十：完成部署

### 10.1 最终检查
```bash
echo "🎉 部署完成！"
echo "📱 移动端优化功能:"
echo "   ✅ 汉堡菜单导航"
echo "   ✅ 多商品网格布局"
echo "   ✅ 商品图片轮播"
echo "   ✅ 营销角标系统"
echo ""
echo "🔗 访问地址: http://47.243.83.253:3000"
```

---

## 🚨 常见问题与解决方案

### 问题1：npm install 报错
**错误信息：** `Permission denied` 或 `ENOSPC`
**解决方案：**
```bash
# 1. 清理npm缓存
npm cache clean --force

# 2. 重新安装
npm install --no-optional
```

### 问题2：git pull 报错
**错误信息：** `Permission denied`
**解决方案：**
```bash
# 配置Git用户信息
git config --global user.email "your-email@example.com"
git config --global user.name "Your Name"

# 重新拉取
git pull origin main
```

### 问题3：pm2 restart 报错
**错误信息：** `Process not found`
**解决方案：**
```bash
# 重新启动
pm2 start npm --name "luckymart-tj" -- start

# 查看所有进程
pm2 list
```

### 问题4：服务启动失败
**查看日志：**
```bash
pm2 logs luckymart-tj
```

### 问题5：数据库连接失败
**解决方案：**
```bash
# 检查环境变量
cat .env

# 重新配置数据库
npx prisma generate
npx prisma db push
```

---

## 🔧 完整复制粘贴版

如果您不想逐个输入命令，可以复制以下完整脚本：

```bash
#!/bin/bash
echo "🚀 开始LuckyMart TJ移动端优化部署..."

# 备份
BACKUP_DIR="/var/backups/luckymart-tj-$(date +%Y%m%d-%H%M%S)"
mkdir -p $BACKUP_DIR
cp -r /var/www/luckymart-tj/* $BACKUP_DIR/ 2>/dev/null || true
echo "✅ 备份完成: $BACKUP_DIR"

# 进入项目目录
cd /var/www/luckymart-tj

# 拉取代码
echo "📥 拉取最新代码..."
git pull origin main

# 安装依赖
echo "🔧 安装依赖..."
npm install

# 数据库迁移
echo "🗄️ 数据库迁移..."
npx prisma generate
npx prisma db push

# 构建项目
echo "⚡ 构建项目..."
npm run build

# 重启服务
echo "🔄 重启服务..."
pm2 restart luckymart-tj || pm2 start npm --name "luckymart-tj" -- start

# 验证
echo "📊 检查状态..."
pm2 status

echo "🎉 部署完成！"
echo "🔗 访问地址: http://47.243.83.253:3000"
```

**使用方法：** 将上述脚本复制粘贴到终端执行

---

## 📞 技术支持

如果在部署过程中遇到任何问题，请保存错误信息并联系技术支持。

**常用诊断命令：**
```bash
# 查看服务状态
pm2 status

# 查看错误日志
pm2 logs luckymart-tj --lines 50

# 检查端口占用
netstat -tlnp | grep :3000

# 检查磁盘空间
df -h

# 检查内存使用
free -h
```

---

## ✅ 部署成功标志

部署成功后，您应该能够：
1. 在 `pm2 status` 中看到 `luckymart-tj` 状态为 `online`
2. 访问 `http://47.243.83.253:3000` 看到网站正常加载
3. 在手机上访问时看到汉堡菜单和新的移动端界面
4. 商品页面显示图片轮播功能

---

**重要提醒：** 如果在执行过程中出现任何红色错误信息，请不要惊慌，先截图保存错误信息，然后联系技术支持。