# ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿ - ç¤ºä¾‹æ•°æ®å’Œæµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿçš„ç¤ºä¾‹æ•°æ®ç”Ÿæˆè„šæœ¬å’ŒAPIæµ‹è¯•è„šæœ¬ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ­å»ºæµ‹è¯•ç¯å¢ƒå¹¶éªŒè¯ç³»ç»ŸåŠŸèƒ½ã€‚

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

### 1. ç¤ºä¾‹æ•°æ®ç”Ÿæˆè„šæœ¬ (`scripts/seed-user-analytics-data.ts`)

ç”Ÿæˆå®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºåˆ†ææµ‹è¯•æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

- **100ä¸ªæµ‹è¯•ç”¨æˆ·**ï¼šå…·æœ‰å®Œæ•´çš„ç”¨æˆ·èµ„æ–™å’Œéšæœºç”Ÿæˆçš„è¡Œä¸ºæ•°æ®
- **ç”¨æˆ·è¡Œä¸ºæ—¥å¿—**ï¼šæ¶µç›–30å¤©å†…çš„å„ç§è¡Œä¸ºç±»å‹ï¼ˆç™»å½•ã€å……å€¼ã€æŠ½å¥–ç­‰ï¼‰
- **å‚ä¸åº¦ç»Ÿè®¡**ï¼š30å¤©çš„ç”¨æˆ·æ´»è·ƒåº¦å’Œå‚ä¸åº¦æ•°æ®
- **ç•™å­˜åˆ†æ**ï¼šç”¨æˆ·åœ¨ä¸åŒæ—¶é—´ç‚¹çš„ç•™å­˜çŠ¶æ€
- **æ¶ˆè´¹åˆ†æ**ï¼šç”¨æˆ·çš„æ¶ˆè´¹è¡Œä¸ºå’Œä»·å€¼åˆ†æ
- **ç”¨æˆ·åˆ†ç¾¤**ï¼š5ä¸ªé¢„è®¾çš„ç”¨æˆ·åˆ†ç¾¤ï¼ˆé«˜ä»·å€¼ç”¨æˆ·ã€æ½œåŠ›æ–°ç”¨æˆ·ã€æµå¤±é£é™©ç”¨æˆ·ã€VIPç”¨æˆ·ã€æ´»è·ƒæŠ½å¥–ç”¨æˆ·ï¼‰

### 2. APIæµ‹è¯•è„šæœ¬ (`test/user-analytics-api.test.ts`)

å…¨é¢æµ‹è¯•æ‰€æœ‰5ä¸ªç”¨æˆ·è¡Œä¸ºåˆ†æAPIç«¯ç‚¹ï¼š

- **ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡API** (`/api/admin/users/behavior`)
- **ç”¨æˆ·å‚ä¸åº¦ç»Ÿè®¡API** (`/api/admin/users/engagement`)
- **ç”¨æˆ·ç•™å­˜åˆ†æAPI** (`/api/admin/users/retention`)
- **ç”¨æˆ·æ¶ˆè´¹åˆ†æAPI** (`/api/admin/users/spending`)
- **ç”¨æˆ·åˆ†ç¾¤API** (`/api/admin/users/segments`)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. ç¡®ä¿é¡¹ç›®ä¾èµ–å·²å®‰è£…ï¼š
```bash
npm install
```

2. ç¡®ä¿æ•°æ®åº“å·²é…ç½®å¹¶è¿è¡Œ
3. ç¡®ä¿ç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼š
```bash
DATABASE_URL=your_database_url
ADMIN_TOKEN=your_admin_token
API_BASE_URL=http://localhost:3000
```

### æ‰§è¡Œç¤ºä¾‹æ•°æ®ç”Ÿæˆ

```bash
# ç”Ÿæˆç”¨æˆ·è¡Œä¸ºåˆ†æç¤ºä¾‹æ•°æ®
npm run seed:user-analytics
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸš€ å¼€å§‹ç”Ÿæˆç”¨æˆ·è¡Œä¸ºåˆ†æç¤ºä¾‹æ•°æ®...

æ¸…ç†ç°æœ‰æµ‹è¯•æ•°æ®...
âœ… æ¸…ç†å®Œæˆ

ç”Ÿæˆæµ‹è¯•ç”¨æˆ·...
å·²åˆ›å»º 10/100 ä¸ªæµ‹è¯•ç”¨æˆ·
...
âœ… æˆåŠŸåˆ›å»º 100 ä¸ªæµ‹è¯•ç”¨æˆ·

âœ… æˆåŠŸç”Ÿæˆ 3000+ æ¡ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
âœ… æˆåŠŸç”Ÿæˆ 3000+ æ¡ç”¨æˆ·å‚ä¸åº¦ç»Ÿè®¡
âœ… æˆåŠŸç”Ÿæˆ 100 æ¡ç”¨æˆ·ç•™å­˜åˆ†æè®°å½•
âœ… æˆåŠŸç”Ÿæˆ 100 æ¡ç”¨æˆ·æ¶ˆè´¹åˆ†æè®°å½•
âœ… æˆåŠŸç”Ÿæˆ 75 æ¡ç”¨æˆ·åˆ†ç¾¤è®°å½•ï¼Œå…± 5 ä¸ªåˆ†ç¾¤

ğŸ‰ ç¤ºä¾‹æ•°æ®ç”Ÿæˆå®Œæˆï¼
ğŸ“Š ç”Ÿæˆç»Ÿè®¡ï¼š
   - æµ‹è¯•ç”¨æˆ·ï¼š100 ä¸ª
   - æ•°æ®æ—¶é—´èŒƒå›´ï¼š30 å¤©
   - è¡Œä¸ºæ—¥å¿—ï¼šçº¦ 5000 æ¡
   - å‚ä¸åº¦ç»Ÿè®¡ï¼š3000 æ¡
   - ç•™å­˜åˆ†æï¼š100 æ¡
   - æ¶ˆè´¹åˆ†æï¼š100 æ¡
   - ç”¨æˆ·åˆ†ç¾¤ï¼š75 æ¡
```

### æ‰§è¡ŒAPIæµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´çš„APIæµ‹è¯•å¥—ä»¶
npm run test:user-analytics-api

# æˆ–è€…ä½¿ç”¨Jestè¿è¡Œç‰¹å®šæµ‹è¯•
npx jest test/user-analytics-api.test.ts

# åªè¿è¡Œç‰¹å®šAPIçš„æµ‹è¯•
npm run test:user-analytics-api -- --testNamePattern="ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡API"
```

**æµ‹è¯•è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸš€ å¼€å§‹ç”¨æˆ·è¡Œä¸ºåˆ†æAPIæµ‹è¯•...

ğŸ“¡ æµ‹è¯•åœ°å€: http://localhost:3000
ğŸ”‘ æµ‹è¯•ä»¤ç‰Œ: test_admin...

ğŸ“Š æµ‹è¯•ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ API - GET
âœ… è·å–ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼ˆåˆ†é¡µï¼‰ (125ms)
âœ… æŒ‰ç”¨æˆ·IDè¿‡æ»¤è¡Œä¸ºæ•°æ® (89ms)
âœ… æŒ‰æ—¥æœŸèŒƒå›´è¿‡æ»¤ (156ms)
âœ… æŒ‰è¡Œä¸ºç±»å‹è¿‡æ»¤ (98ms)
âŒ æ— æ•ˆæƒé™ä»¤ç‰Œæµ‹è¯•: æœŸæœ›çŠ¶æ€ç  403ï¼Œå®é™… 200

ğŸ“ æµ‹è¯•ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ API - POST
âœ… è®°å½•æ–°ç”¨æˆ·è¡Œä¸º (245ms)
âœ… è®°å½•å……å€¼è¡Œä¸º (189ms)
âŒ æ— æ•ˆæ•°æ®æµ‹è¯•: æœŸæœ›çŠ¶æ€ç  400ï¼Œå®é™… 200

...

============================================================
ğŸ“‹ æµ‹è¯•æŠ¥å‘Š
============================================================
ğŸ“Š æµ‹è¯•ç»Ÿè®¡:
   æ€»æµ‹è¯•æ•°: 25
   âœ… é€šè¿‡: 23
   âŒ å¤±è´¥: 2
   æˆåŠŸç‡: 92.0%
   æ€»è€—æ—¶: 3245ms

âš ï¸  æœ‰ 2 ä¸ªæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå®ç°
============================================================
```

## ğŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜

### ç¤ºä¾‹æ•°æ®ç”Ÿæˆè„šæœ¬

#### å‘½ä»¤è¡Œé€‰é¡¹

è„šæœ¬æ”¯æŒä»¥ä¸‹ç¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
# å¯é€‰ï¼šè‡ªå®šä¹‰æµ‹è¯•ç”¨æˆ·æ•°é‡ï¼ˆé»˜è®¤100ï¼‰
TEST_USER_COUNT=50 npm run seed:user-analytics

# å¯é€‰ï¼šè‡ªå®šä¹‰ç”Ÿæˆå¤©æ•°ï¼ˆé»˜è®¤30ï¼‰
DAYS_TO_GENERATE=60 npm run seed:user-analytics
```

#### æ•°æ®ç»“æ„

ç”Ÿæˆçš„æ•°æ®åŒ…å«ä»¥ä¸‹ä¸»è¦è¡¨ï¼š

1. **user_behavior_logs** - ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
   - è¡Œä¸ºç±»å‹ï¼šlogin, logout, registration, recharge, lottery_participation, product_purchase, withdrawal, invitation
   - æ—¶é—´è·¨åº¦ï¼š30å¤©
   - è®¾å¤‡ä¿¡æ¯ï¼šiOS, Android, Web, Telegram

2. **user_engagement_stats** - ç”¨æˆ·å‚ä¸åº¦ç»Ÿè®¡
   - ç™»å½•æ¬¡æ•°ï¼š0-8æ¬¡/å¤©
   - ä¼šè¯æ—¶é•¿ï¼š0-3600ç§’
   - é¡µé¢æµè§ˆï¼š0-50é¡µ/å¤©
   - å‚ä¸åº¦è¯„åˆ†ï¼š0-100åˆ†

3. **retention_analysis** - ç”¨æˆ·ç•™å­˜åˆ†æ
   - ç•™å­˜æ—¶é—´ç‚¹ï¼šday_0, day_1, day_3, day_7, day_14, day_30, day_60, day_90
   - ç•™å­˜ç‡é€’å‡ï¼šday_1(60%), day_3(40%), day_7(30%), day_30(15%)

4. **spending_analysis** - ç”¨æˆ·æ¶ˆè´¹åˆ†æ
   - æ¶ˆè´¹åˆ†ç¾¤ï¼šlow, medium, high, vip
   - CLVè®¡ç®—ï¼šåŸºäºæ¶ˆè´¹é‡‘é¢å’Œé¢‘ç‡
   - æµå¤±é£é™©ï¼š0-100åˆ†

5. **user_segments** - ç”¨æˆ·åˆ†ç¾¤
   - 5ä¸ªé¢„è®¾åˆ†ç¾¤ï¼Œæ¯ä¸ªåˆ†ç¾¤15-25ä¸ªç”¨æˆ·
   - åˆ†ç¾¤æ ‡å‡†åŸºäºå‚ä¸åº¦ã€æ¶ˆè´¹ã€æ´»è·ƒåº¦

### APIæµ‹è¯•è„šæœ¬

#### æµ‹è¯•è¦†ç›–èŒƒå›´

1. **æƒé™éªŒè¯æµ‹è¯•**
   - æœ‰æ•ˆç®¡ç†å‘˜ä»¤ç‰ŒéªŒè¯
   - æ— æ•ˆä»¤ç‰Œæ‹’ç»è®¿é—®
   - æƒé™ä¸è¶³é”™è¯¯å¤„ç†

2. **æ•°æ®æŸ¥è¯¢æµ‹è¯•**
   - åˆ†é¡µæŸ¥è¯¢
   - æ¡ä»¶è¿‡æ»¤ï¼ˆç”¨æˆ·IDã€æ—¥æœŸã€ç±»å‹ï¼‰
   - æ’åºå’Œé™åˆ¶

3. **æ•°æ®æ“ä½œæµ‹è¯•**
   - POSTåˆ›å»ºæ–°è®°å½•
   - PUTæ›´æ–°ç°æœ‰è®°å½•
   - DELETEåˆ é™¤è®°å½•

4. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - æ— æ•ˆå‚æ•°å¤„ç†
   - ä¸å­˜åœ¨èµ„æºå¤„ç†
   - æ ¼å¼é”™è¯¯å¤„ç†

#### è‡ªå®šä¹‰æµ‹è¯•é…ç½®

```typescript
// åœ¨ test/user-analytics-api.test.ts ä¸­ä¿®æ”¹é…ç½®
const BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000';
const ADMIN_TOKEN = process.env.ADMIN_TOKEN || 'your_test_token';
```

#### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# åªæµ‹è¯•ç‰¹å®šAPI
npm run test:user-analytics-api -- --testNamePattern="ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡API"

# æµ‹è¯•ç‰¹å®šæ–¹æ³•
npm run test:user-analytics-api -- --testNamePattern="GETè¯·æ±‚"

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
npm run test:user-analytics-api -- --verbose
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹

åœ¨ `test/user-analytics-api.test.ts` ä¸­æ·»åŠ æ–°çš„æµ‹è¯•æ–¹æ³•ï¼š

```typescript
async testCustomApi(): Promise<void> {
  console.log('\nğŸ”§ æµ‹è¯•è‡ªå®šä¹‰API');
  
  await this.testRequest(
    'è‡ªå®šä¹‰APIæµ‹è¯•',
    () => axios.get(`${this.baseURL}/api/custom/endpoint`, { headers: this.adminHeaders })
  );
}
```

### ä¿®æ”¹ç¤ºä¾‹æ•°æ®

åœ¨ `scripts/seed-user-analytics-data.ts` ä¸­è°ƒæ•´ç”Ÿæˆå‚æ•°ï¼š

```typescript
// ä¿®æ”¹ç”¨æˆ·æ•°é‡
const TEST_USER_COUNT = 200;

// ä¿®æ”¹è¡Œä¸ºç±»å‹
const BEHAVIOR_TYPES = ['custom_action', 'another_action'];

// ä¿®æ”¹åˆ†ç¾¤å®šä¹‰
const segments = [
  {
    segment_name: 'è‡ªå®šä¹‰åˆ†ç¾¤',
    criteria: {
      custom_field: 'value'
    }
  }
];
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### æ‰¹é‡æ’å…¥ä¼˜åŒ–

ç¤ºä¾‹æ•°æ®ç”Ÿæˆè„šæœ¬ä½¿ç”¨æ‰¹é‡æ’å…¥æ¥æé«˜æ€§èƒ½ï¼š

```typescript
// æ‰¹é‡å¤§å°æ§åˆ¶
const batchSize = 1000;
for (let i = 0; i < dataToCreate.length; i += batchSize) {
  const batch = dataToCreate.slice(i, i + batchSize);
  await prisma.tableName.createMany({ data: batch });
}
```

### å†…å­˜ç®¡ç†

å¯¹äºå¤§æ•°æ®é›†ç”Ÿæˆï¼Œå»ºè®®åˆ†æ‰¹å¤„ç†ï¼š

```typescript
// é¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜
for (const batch of dataBatches) {
  await processBatch(batch);
  // æ¸…ç†å†…å­˜
  if (global.gc) global.gc();
}
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```
   Error: Can't connect to database
   ```
   - æ£€æŸ¥ DATABASE_URL ç¯å¢ƒå˜é‡
   - ç¡®ä¿æ•°æ®åº“æœåŠ¡æ­£åœ¨è¿è¡Œ
   - éªŒè¯æ•°æ®åº“æƒé™

2. **æƒé™éªŒè¯å¤±è´¥**
   ```
   Error: ç®¡ç†å‘˜æƒé™éªŒè¯å¤±è´¥
   ```
   - æ£€æŸ¥ ADMIN_TOKEN ç¯å¢ƒå˜é‡
   - ç¡®è®¤ä»¤ç‰Œåœ¨æ•°æ®åº“ä¸­å­˜åœ¨ä¸”æœ‰æ•ˆ

3. **APIå“åº”æ ¼å¼é”™è¯¯**
   ```
   Error: Expected API response format
   ```
   - ç¡®è®¤APIç«¯ç‚¹æ­£ç¡®è¿”å› `{ success, data, error }` æ ¼å¼
   - æ£€æŸ¥APIæ˜¯å¦æ­£ç¡®å¤„ç†è¯·æ±‚å‚æ•°

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼š

```bash
# å¯ç”¨Jestè¯¦ç»†æ¨¡å¼
npm run test:user-analytics-api -- --verbose

# å¯ç”¨Jestè°ƒè¯•æ¨¡å¼
npm run test:user-analytics-api -- --detectOpenHandles

# å¯ç”¨TypeScriptä¸¥æ ¼æ£€æŸ¥
npx tsx --inspect-brk test/user-analytics-api.test.ts
```

## ğŸ“ æµ‹è¯•æ•°æ®æ¸…ç†

### æ¸…ç†æµ‹è¯•æ•°æ®

```bash
# æ‰‹åŠ¨æ¸…ç†ç”¨æˆ·è¡Œä¸ºåˆ†æç›¸å…³æ•°æ®
npm run seed:user-analytics  # é‡æ–°ç”Ÿæˆä¼šè‡ªåŠ¨æ¸…ç†æ—§æ•°æ®
```

### é€‰æ‹©æ€§æ¸…ç†

```sql
-- åªæ¸…ç†ç‰¹å®šè¡¨
DELETE FROM user_segments;
DELETE FROM spending_analysis;
DELETE FROM retention_analysis;
DELETE FROM user_engagement_stats;
DELETE FROM user_behavior_logs;
DELETE FROM users WHERE telegram_id LIKE 'test_user_%';
```

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### æ·»åŠ æ–°çš„ç”¨æˆ·åˆ†ç¾¤æ ‡å‡†

```typescript
const customSegments = [
  {
    segment_name: 'é«˜æ´»è·ƒæŠ½å¥–ç”¨æˆ·',
    criteria: {
      min_lottery_participation: 20,
      min_engagement_score: 70,
      max_days_since_last_activity: 3
    }
  }
];
```

### æ·»åŠ æ–°çš„å‚ä¸åº¦æŒ‡æ ‡

```typescript
const engagementMetrics = {
  social_shares: getRandomInt(0, 10),
  referrals_sent: getRandomInt(0, 5),
  social_engagement_score: getRandomInt(0, 100)
};
```

## ğŸ“ æ”¯æŒ

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. ç¡®ä¿æ‰€æœ‰ä¾èµ–åŒ…å·²æ­£ç¡®å®‰è£…
2. ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
3. æ•°æ®åº“è¿æ¥æ­£å¸¸
4. APIç«¯ç‚¹å¯è®¿é—®

æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚