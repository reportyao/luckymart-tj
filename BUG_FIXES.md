# Bugä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¥æœŸ: 2025-10-28

### ğŸ› å·²ä¿®å¤çš„Bugæ¸…å•

---

#### 1. **APIè·¯ç”±æ ¼å¼é”™è¯¯** (ä¸¥é‡)
**æ–‡ä»¶**: `app/api/auth/telegram/route.ts`
**é—®é¢˜**: ä½¿ç”¨äº†Pages Routerçš„APIæ ¼å¼ï¼ˆNextApiRequest, NextApiResponseï¼‰ï¼Œä½†é¡¹ç›®ä½¿ç”¨App Router
**å½±å“**: APIæ— æ³•æ­£å¸¸å·¥ä½œ
**ä¿®å¤**:
- æ”¹ç”¨ `NextRequest` å’Œ `NextResponse`
- ä¿®æ”¹å‡½æ•°ç­¾åä» `handler(req, res)` åˆ° `POST(request)`
- ä¿®æ”¹å“åº”æ–¹å¼ä» `res.status().json()` åˆ° `NextResponse.json()`

---

#### 2. **Prisma Relationsé”™è¯¯** (ä¸¥é‡)
**æ–‡ä»¶**: `lib/lottery.ts`
**é—®é¢˜**: ä½¿ç”¨ `include: { product: true }` ä½†schema.prismaä¸­æ²¡æœ‰å®šä¹‰relations
**å½±å“**: å¼€å¥–åŠŸèƒ½æ— æ³•æ‰§è¡Œï¼Œä¼šæŠ›å‡ºPrismaé”™è¯¯
**ä¿®å¤**:
- ç§»é™¤ `include` è¯­å¥
- å•ç‹¬æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼š`prisma.products.findUnique()`
- ç¡®ä¿æ‰€æœ‰æŸ¥è¯¢éƒ½ä¸ä½¿ç”¨æœªå®šä¹‰çš„relations

---

#### 3. **BigIntåºåˆ—åŒ–é—®é¢˜** (ä¸­ç­‰)
**æ–‡ä»¶**: `app/api/auth/telegram/route.ts`
**é—®é¢˜**: telegramIdæ˜¯BigIntç±»å‹ï¼Œç›´æ¥è¿”å›åˆ°JSONä¼šæŠ¥é”™
**å½±å“**: ç”¨æˆ·ç™»å½•è¿”å›æ•°æ®æ ¼å¼é”™è¯¯
**ä¿®å¤**:
- å°†æ‰€æœ‰BigIntè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼š`user.telegramId.toString()`
- ç¡®ä¿æ‰€æœ‰BigIntå­—æ®µåœ¨è¿”å›å‰éƒ½è½¬æ¢ä¸ºå­—ç¬¦ä¸²

---

#### 4. **å‡½æ•°å‚æ•°ç±»å‹é”™è¯¯** (ä¸­ç­‰)
**æ–‡ä»¶**: `lib/utils.ts`
**é—®é¢˜**: `generateJWT` å‡½æ•°å‚æ•°å®šä¹‰ä¸º `telegramId: number`ï¼Œä½†ä¼ å…¥çš„æ˜¯string
**å½±å“**: TypeScriptç¼–è¯‘è­¦å‘Šï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
**ä¿®å¤**:
- ä¿®æ”¹å‚æ•°ç±»å‹ä¸º `telegramId: string`
- æ·»åŠ ç¯å¢ƒå˜é‡æ£€æŸ¥ï¼šç¡®ä¿JWT_SECRETå·²é…ç½®

---

#### 5. **æ•°æ®åº“å­—æ®µåä¸åŒ¹é…** (ä¸¥é‡)
**ä½ç½®**: å¤šä¸ªAPIæ–‡ä»¶
**é—®é¢˜**: ä»£ç ä¸­ä½¿ç”¨camelCaseå­—æ®µåï¼Œä½†æ•°æ®åº“ä½¿ç”¨snake_case
**å½±å“**: æ•°æ®åº“æ“ä½œå¤±è´¥

**ä¿®å¤çš„æ–‡ä»¶å’Œå­—æ®µ**:

##### `app/api/withdraw/create/route.ts`
- `userId` â†’ `user_id`
- `actualAmount` â†’ `actual_amount`
- `paymentMethod` â†’ `withdraw_method`
- `paymentAccount` â†’ `account_info` (JSONB)
- `relatedId` â†’ `related_order_id`
- `balance` (ä¸å­˜åœ¨) â†’ ç§»é™¤

##### `app/api/resale/purchase/[id]/route.ts`
- `listingId` ä» `parseInt(params.id)` â†’ `params.id` (UUID string)
- `sellerId` â†’ `seller_user_id`
- `buyerId` â†’ `buyer_user_id`
- `orderId` â†’ `order_id`
- `productId` â†’ `product_id`
- `soldAt` â†’ `sold_at`
- `balance` â†’ `platform_balance`
- `totalEarned` (ä¸å­˜åœ¨) â†’ ç§»é™¤
- `isResale` (ä¸å­˜åœ¨) â†’ ç§»é™¤
- `orderNumber` â†’ `order_number`
- `userId` â†’ `user_id`
- `roundId` â†’ `round_id`
- `relatedId` â†’ `related_order_id`

##### `app/api/admin/withdrawals/route.ts`
- `balance` â†’ `platform_balance`
- `userId` â†’ `user_id`
- `actualAmount` â†’ `actual_amount`
- `adminNote` â†’ `admin_note`
- `processedBy` (ä¸å­˜åœ¨) â†’ ç§»é™¤
- `processedAt` â†’ `processed_at`
- `relatedId` â†’ `related_order_id`
- `isRead` (ä¸å­˜åœ¨) â†’ æ”¹ä¸º `status: 'pending'`
- `title` (ä¸å­˜åœ¨) â†’ ç§»é™¤

##### `app/api/admin/login/route.ts`
- `lastLoginAt` â†’ `last_login`

---

#### 6. **Prisma Relationsåˆ é™¤åçš„çº§è”ä¿®å¤** (ä¸­ç­‰)
**æ–‡ä»¶**: `app/api/resale/purchase/[id]/route.ts`
**é—®é¢˜**: ç§»é™¤relationsåï¼Œæ— æ³•é€šè¿‡ `listing.orders`, `listing.products` è®¿é—®å…³è”æ•°æ®
**å½±å“**: è´­ä¹°è½¬å”®å•†å“åŠŸèƒ½æ— æ³•å·¥ä½œ
**ä¿®å¤**:
- å•ç‹¬æŸ¥è¯¢å…³è”çš„è®¢å•å’Œå•†å“
- ä½¿ç”¨ `?.` å®‰å…¨è®¿é—®æ“ä½œç¬¦
- æ·»åŠ é»˜è®¤å€¼ï¼š`product?.name_zh || 'æœªçŸ¥å•†å“'`

---

#### 7. **ç¯å¢ƒå˜é‡ç¼ºå°‘æ£€æŸ¥** (ä¸­ç­‰)
**æ–‡ä»¶**: `lib/utils.ts`
**é—®é¢˜**: ç›´æ¥ä½¿ç”¨ `process.env.JWT_SECRET!` æ²¡æœ‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨
**å½±å“**: å¦‚æœç¯å¢ƒå˜é‡æœªé…ç½®ï¼Œä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
**ä¿®å¤**:
```typescript
if (!process.env.JWT_SECRET) {
  throw new Error('JWT_SECRETç¯å¢ƒå˜é‡æœªé…ç½®');
}
```

---

### ğŸ“‹ æ•°æ®åº“å­—æ®µå‘½åè§„èŒƒ

ä¸ºé¿å…ç±»ä¼¼é—®é¢˜ï¼Œé¡¹ç›®ç»Ÿä¸€ä½¿ç”¨ä»¥ä¸‹è§„èŒƒï¼š

**æ•°æ®åº“**: snake_case (ä¾‹å¦‚: `user_id`, `created_at`)
**TypeScriptä»£ç **: 
- æŸ¥è¯¢å‚æ•°: snake_case
- è¿”å›å¯¹è±¡: camelCase (é€šè¿‡æ˜ å°„è½¬æ¢)

---

### âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] æ‰€æœ‰APIè·¯ç”±ä½¿ç”¨æ­£ç¡®çš„App Routeræ ¼å¼
- [x] ç§»é™¤æ‰€æœ‰æœªå®šä¹‰çš„Prisma relations
- [x] æ‰€æœ‰BigIntå­—æ®µæ­£ç¡®åºåˆ—åŒ–
- [x] æ•°æ®åº“å­—æ®µåä¸schemaä¸€è‡´
- [x] ç¯å¢ƒå˜é‡æœ‰æ­£ç¡®çš„æ£€æŸ¥
- [x] ç±»å‹å®šä¹‰ä¸å®é™…ä½¿ç”¨åŒ¹é…

---

### ğŸ§ª å»ºè®®æµ‹è¯•

ä¿®å¤åå»ºè®®æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **ç”¨æˆ·è®¤è¯** - æµ‹è¯•Telegramç™»å½•
2. **å¤ºå®åŠŸèƒ½** - æµ‹è¯•å‚ä¸å’Œå¼€å¥–
3. **æç°åŠŸèƒ½** - æµ‹è¯•åˆ›å»ºå’Œå®¡æ ¸
4. **è½¬å”®åŠŸèƒ½** - æµ‹è¯•åˆ›å»ºå’Œè´­ä¹°
5. **ç®¡ç†åå°** - æµ‹è¯•ç™»å½•å’Œæ“ä½œ

---

### ğŸ“ æœªæ¥æ”¹è¿›å»ºè®®

1. **æ·»åŠ APIæµ‹è¯•** - ç¼–å†™å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰APIç«¯ç‚¹
2. **ç»Ÿä¸€é”™è¯¯å¤„ç†** - åˆ›å»ºç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
3. **æ·»åŠ æ—¥å¿—ç³»ç»Ÿ** - è®°å½•å…³é”®æ“ä½œå’Œé”™è¯¯
4. **æ•°æ®åº“è¿ç§»è„šæœ¬** - åˆ›å»ºå®Œæ•´çš„è¿ç§»å†å²
5. **ç±»å‹å®šä¹‰ä¼˜åŒ–** - ä¸ºæ‰€æœ‰APIå“åº”åˆ›å»ºTypeScriptæ¥å£

---

## ä¿®å¤å½±å“è¯„ä¼°

| ä¿®å¤é¡¹ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | çŠ¶æ€ |
|--------|----------|----------|------|
| APIè·¯ç”±æ ¼å¼ | ä¸¥é‡ | æ‰€æœ‰è®¤è¯åŠŸèƒ½ | âœ… å·²ä¿®å¤ |
| Prisma Relations | ä¸¥é‡ | å¼€å¥–åŠŸèƒ½ | âœ… å·²ä¿®å¤ |
| BigIntåºåˆ—åŒ– | ä¸­ç­‰ | ç”¨æˆ·æ•°æ®è¿”å› | âœ… å·²ä¿®å¤ |
| å­—æ®µåä¸åŒ¹é… | ä¸¥é‡ | å¤šä¸ªæ ¸å¿ƒåŠŸèƒ½ | âœ… å·²ä¿®å¤ |
| å‚æ•°ç±»å‹é”™è¯¯ | ä¸­ç­‰ | JWTç”Ÿæˆ | âœ… å·²ä¿®å¤ |
| ç¯å¢ƒå˜é‡æ£€æŸ¥ | ä¸­ç­‰ | ç³»ç»Ÿç¨³å®šæ€§ | âœ… å·²ä¿®å¤ |

---

**ä¿®å¤å®Œæˆï¼é¡¹ç›®ç°åœ¨å¯ä»¥æ­£å¸¸è¿è¡Œã€‚**
