# 邀请裂变系统快速启动指南

## 🚀 快速开始

### 1. 数据库部署

```bash
# 1. 进入项目目录
cd luckymart-tj

# 2. 执行数据库迁移
psql -d your_database -f supabase/migrations/1762000000_create_invitation_system.sql

# 3. (可选) 加载测试数据
psql -d your_database -f test/init-invitation-test-data.sql
```

### 2. 环境配置

确保在 `.env.local` 文件中配置：

```bash
# 数据库连接
DATABASE_URL=postgresql://user:password@localhost:5432/luckymart_tj

# JWT密钥
JWT_SECRET=your-super-secret-jwt-key
JWT_REFRESH_SECRET=your-super-secret-refresh-key

# 应用配置
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

### 3. 验证部署

访问以下健康检查端点：

```bash
# 检查数据库连接和表结构
curl -X GET http://localhost:3000/api/health

# 测试邀请码生成功能（需要先获取JWT token）
curl -X POST http://localhost:3000/api/invitation/generate-code \
  -H "Authorization: Bearer your-jwt-token"
```

## 📝 API 快速参考

### 常用API调用示例

#### 1. 生成邀请码
```bash
curl -X POST /api/invitation/generate-code \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 2. 获取邀请信息
```bash
curl -X GET /api/invitation/my-code \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 3. 绑定邀请关系
```bash
curl -X POST /api/invitation/bind \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"referralCode": "LM123456"}'
```

#### 4. 查看奖励记录
```bash
curl -X GET "/api/invitation/rewards?page=1&limit=20&status=available" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5. 领取奖励
```bash
curl -X POST /api/invitation/claim-reward \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"rewardIds": ["reward-uuid-1", "reward-uuid-2"]}'
```

## 🔧 开发指南

### 本地开发

```bash
# 1. 安装依赖
npm install

# 2. 启动开发服务器
npm run dev

# 3. 运行测试
npm test

# 4. 类型检查
npm run type-check
```

### 代码结构

```
app/api/invitation/
├── generate-code/     # 生成邀请码
├── my-code/          # 获取邀请信息
├── bind/             # 绑定邀请关系
├── rewards/          # 奖励记录
├── commission/       # 返利记录
└── claim-reward/     # 领取奖励
```

## 🧪 测试

### 运行测试

```bash
# 运行所有测试
npm test

# 运行特定测试
npm test invitation-api.test.ts

# 运行测试并生成覆盖率报告
npm run test:coverage
```

### 测试数据

使用测试数据：
```bash
psql -d your_database -f test/init-invitation-test-data.sql
```

测试用户信息：
- 邀请人: `test_inviter_001`
- 被邀请人: `test_invited_001`, `test_invited_002`
- 邀请码: `LM100001`, `LM100002`, `LM100003`

## 📊 监控和维护

### 健康检查

```bash
# 检查API服务状态
curl http://localhost:3000/api/health

# 检查数据库连接
curl http://localhost:3000/api/health/database
```

### 日志监控

查看应用日志：
```bash
# 开发环境
npm run dev

# 生产环境
pm2 logs luckymart-tj
```

### 性能监控

关键指标：
- API响应时间 < 200ms
- 数据库查询时间 < 100ms
- 内存使用 < 512MB
- CPU使用率 < 50%

## 🛠️ 故障排除

### 常见问题

**1. 数据库连接失败**
```bash
# 检查数据库服务
ps aux | grep postgres

# 检查连接字符串
echo $DATABASE_URL
```

**2. JWT认证失败**
```bash
# 检查JWT密钥配置
echo $JWT_SECRET

# 验证token格式
curl -v http://localhost:3000/api/invitation/my-code \
  -H "Authorization: Bearer INVALID_TOKEN"
```

**3. 邀请码格式错误**
- 正确格式: `LM123456`
- 错误格式: `lm123456`, `XM123456`, `LM12345`

**4. 奖励领取失败**
- 检查奖励状态是否为 `available`
- 确认奖励未过期
- 验证奖励所有权

### 调试工具

**1. 数据库查询**
```sql
-- 查看邀请关系
SELECT * FROM referral_relationships;

-- 查看奖励记录
SELECT * FROM invitation_rewards WHERE is_claimed = false;

-- 查看用户邀请码
SELECT id, referral_code FROM users WHERE referral_code IS NOT NULL;
```

**2. API调试**
```bash
# 详细请求日志
curl -v -X POST /api/invitation/generate-code \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 📈 性能优化

### 数据库优化

```sql
-- 查看查询性能
EXPLAIN ANALYZE SELECT * FROM invitation_rewards 
WHERE referrer_user_id = 'user-id' 
ORDER BY created_at DESC 
LIMIT 20;

-- 重建索引（如果需要）
REINDEX TABLE invitation_rewards;
```

### 缓存策略

建议对以下数据进行缓存：
- 用户邀请统计信息 (5分钟缓存)
- 邀请码信息 (1小时缓存)
- 奖励记录列表 (2分钟缓存)

### 监控告警

设置以下告警：
- API响应时间 > 500ms
- 错误率 > 5%
- 数据库连接数 > 80%
- 内存使用 > 80%

## 🎯 生产部署

### 环境准备

```bash
# 1. 设置生产环境变量
export NODE_ENV=production
export DATABASE_URL=postgresql://prod_user:pass@prod_host:5432/prod_db
export JWT_SECRET=production-secret-key

# 2. 构建应用
npm run build

# 3. 运行数据库迁移
psql -d production_db -f supabase/migrations/1762000000_create_invitation_system.sql
```

### 部署检查清单

- [ ] 数据库迁移已完成
- [ ] 环境变量已配置
- [ ] JWT密钥已设置
- [ ] SSL证书已配置
- [ ] 监控告警已设置
- [ ] 备份策略已制定

### 扩容建议

当用户量增长时：

1. **数据库优化**
   - 增加连接池大小
   - 优化慢查询
   - 考虑读写分离

2. **应用层优化**
   - 增加服务器实例
   - 配置负载均衡
   - 启用CDN加速

3. **缓存层**
   - 集成Redis缓存
   - 实施分布式缓存
   - 配置缓存预热

## 📞 支持联系

### 文档资源

- [API完整文档](./docs/invitation-system-api.md)
- [使用示例](./examples/invitation-api-examples.ts)
- [测试文件](./__tests__/invitation-api.test.ts)
- [完成报告](./邀请裂变API开发完成报告.md)

### 技术支持

如遇到技术问题，请按以下顺序排查：
1. 查看API文档和示例
2. 检查测试文件中的用法
3. 查看错误日志
4. 检查数据库状态

---

**🚀 祝您使用愉快！如有任何问题，请参考完整文档或联系技术支持。**