# Telegram Bot éƒ¨ç½²å’Œä½¿ç”¨æŒ‡å—

## Bot ä¿¡æ¯
- **Bot Token**: `8074258399:AAG1WdyCJe4vphx9YB3B6z60nTE3dhBBP-Q`
- **Bot Username**: @LuckyMartTJ_botï¼ˆéœ€è¦åœ¨BotFatherä¸­æŸ¥çœ‹ç¡®åˆ‡ç”¨æˆ·åï¼‰

## ä¸€ã€Bot éƒ¨ç½²çŠ¶æ€

### æ£€æŸ¥Botæ˜¯å¦å·²éƒ¨ç½²

ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹PM2è¿›ç¨‹ï¼š
```bash
ssh root@47.243.83.253
pm2 list
```

å¦‚æœçœ‹åˆ°`luckymart-bot`è¿›ç¨‹ï¼š
- **Status: online** - Botæ­£å¸¸è¿è¡Œ
- **Status: stopped/errored** - Botéœ€è¦é‡å¯æˆ–ä¿®å¤

### éƒ¨ç½²Botåˆ°æœåŠ¡å™¨

å¦‚æœBotæœªéƒ¨ç½²æˆ–éœ€è¦é‡æ–°éƒ¨ç½²ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/luckymart-tj

# 2. ç¼–è¯‘TypeScriptï¼ˆBotä»£ç ï¼‰
npx tsc bot/index.ts --outDir dist/bot --esModuleInterop --resolveJsonModule --module commonjs

# 3. ä½¿ç”¨PM2å¯åŠ¨Bot
pm2 start dist/bot/index.js --name luckymart-bot

# 4. ä¿å­˜PM2é…ç½®ï¼ˆå¼€æœºè‡ªå¯ï¼‰
pm2 save

# 5. æŸ¥çœ‹Botæ—¥å¿—
pm2 logs luckymart-bot
```

### å¸¸ç”¨Botç®¡ç†å‘½ä»¤

```bash
# é‡å¯Bot
pm2 restart luckymart-bot

# åœæ­¢Bot
pm2 stop luckymart-bot

# æŸ¥çœ‹Botå®æ—¶æ—¥å¿—
pm2 logs luckymart-bot --lines 100

# æŸ¥çœ‹BotçŠ¶æ€
pm2 info luckymart-bot
```

## äºŒã€å¦‚ä½•åœ¨Telegramä¸­åˆ›å»ºç”¨æˆ·

### æ–¹æ³•1ï¼šé€šè¿‡Botçš„ /start å‘½ä»¤ï¼ˆæ¨èï¼‰

1. **æ‰“å¼€Telegramåº”ç”¨**

2. **æœç´¢Bot**
   - åœ¨æœç´¢æ¡†è¾“å…¥: `@ä½ çš„botç”¨æˆ·å`ï¼ˆä¾‹å¦‚ï¼š`@LuckyMartTJ_bot`ï¼‰
   - æˆ–ç›´æ¥è®¿é—®: `https://t.me/ä½ çš„botç”¨æˆ·å`

3. **å¯åŠ¨Bot**
   - ç‚¹å‡»"START"æŒ‰é’®æˆ–è¾“å…¥ `/start`
   - Botä¼šè‡ªåŠ¨ï¼š
     - åˆ›å»ºç”¨æˆ·è´¦æˆ·ï¼ˆå…³è”Telegram IDï¼‰
     - èµ é€50å¤ºå®å¸ï¼ˆæ–°ç”¨æˆ·å¥–åŠ±ï¼‰
     - è®¾ç½®æ¯æ—¥3æ¬¡å…è´¹å‚ä¸
     - æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’ŒåŠŸèƒ½æŒ‰é’®

4. **éªŒè¯ç”¨æˆ·åˆ›å»ºæˆåŠŸ**
   - è¾“å…¥ `/balance` æŸ¥çœ‹è´¦æˆ·ä½™é¢
   - åº”è¯¥æ˜¾ç¤ºï¼š
     ```
     å¤ºå®å¸ï¼š50 å¸
     å¹³å°ä½™é¢ï¼š0 TJS
     VIPç­‰çº§ï¼š0
     ä»Šæ—¥å…è´¹æ¬¡æ•°ï¼š3/3
     ```

### æ–¹æ³•2ï¼šé€šè¿‡Webç«¯æ³¨å†Œï¼ˆå¦‚æœå®ç°äº†æ³¨å†ŒåŠŸèƒ½ï¼‰

1. è®¿é—®ç½‘ç«™: `http://47.243.83.253:3000`
2. ç‚¹å‡»"æ³¨å†Œ"æˆ–"ç™»å½•"
3. ä½¿ç”¨Telegramç™»å½•ï¼ˆTelegram Login Widgetï¼‰

## ä¸‰ã€Botæ ¸å¿ƒå‘½ä»¤ä½¿ç”¨

### ç”¨æˆ·å‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `/start` | æ³¨å†Œå¹¶å¯åŠ¨Botï¼Œæ˜¾ç¤ºä¸»èœå• | `/start` |
| `/balance` | æŸ¥è¯¢è´¦æˆ·ä½™é¢å’ŒVIPç­‰çº§ | `/balance` |
| `/orders` | æŸ¥çœ‹æœ€è¿‘è®¢å•è®°å½• | `/orders` |
| `/myproducts` | æŸ¥çœ‹æˆ‘çš„å¤ºå®è®°å½• | `/myproducts` |
| `/help` | æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ | `/help` |
| `/settings` | ä¸ªäººè®¾ç½®ï¼ˆè¯­è¨€ã€é€šçŸ¥ï¼‰ | `/settings` |

### ç®¡ç†å‘˜å‘½ä»¤ï¼ˆéœ€è¦é…ç½®ï¼‰

| å‘½ä»¤ | åŠŸèƒ½ | é™åˆ¶ |
|------|------|------|
| `/admin` | è¿›å…¥ç®¡ç†æ¨¡å¼ | ä»…ç®¡ç†å‘˜ |
| `/stats` | æŸ¥çœ‹å¹³å°ç»Ÿè®¡æ•°æ® | ä»…ç®¡ç†å‘˜ |
| `/broadcast` | ç¾¤å‘æ¶ˆæ¯ | ä»…ç®¡ç†å‘˜ |

## å››ã€Botä¸Webç«¯äº¤äº’æµç¨‹

### å®Œæ•´ç”¨æˆ·æ—…ç¨‹

1. **å†·å¯åŠ¨ï¼ˆTelegram Botï¼‰**
   ```
   ç”¨æˆ· -> Telegram Bot -> /start
   Bot -> åˆ›å»ºè´¦æˆ· -> èµ é€50å¸ -> æ˜¾ç¤ºä¸»èœå•
   Bot -> "è¿›å…¥å¹¸è¿é›†å¸‚" æŒ‰é’® -> æ‰“å¼€Mini App (Web)
   ```

2. **æµè§ˆå’Œå‚ä¸ï¼ˆWebç«¯ï¼‰**
   ```
   ç”¨æˆ· -> Webç«¯ -> æµè§ˆå•†å“ -> é€‰æ‹©å•†å“ -> å‚ä¸å¤ºå®
   Web -> è°ƒç”¨API -> æ‰£é™¤å¤ºå®å¸ -> åˆ†é…å·ç  -> è¿”å›ç»“æœ
   ```

3. **å¼€å¥–é€šçŸ¥ï¼ˆBotæ¨é€ï¼‰**
   ```
   ç³»ç»Ÿ -> è‡ªåŠ¨å¼€å¥– -> ç¡®å®šä¸­å¥–è€…
   Bot -> æ¨é€é€šçŸ¥ -> "@username æ­å–œä¸­å¥–ï¼"
   Bot -> æç¤ºå¡«å†™æ”¶è´§åœ°å€ -> æ‰“å¼€åœ°å€å¡«å†™é¡µé¢
   ```

4. **è®¢å•å±¥çº¦ï¼ˆBot+Webï¼‰**
   ```
   ç”¨æˆ· -> å¡«å†™åœ°å€ -> æäº¤
   ç®¡ç†å‘˜ -> Webåå° -> æ ‡è®°å‘è´§
   Bot -> æ¨é€å‘è´§é€šçŸ¥ -> ç”¨æˆ·æŸ¥çœ‹ç‰©æµ
   ```

## äº”ã€Boté€šçŸ¥æ¨é€åŠŸèƒ½

Botä¼šåœ¨ä»¥ä¸‹åœºæ™¯è‡ªåŠ¨æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ·ï¼š

### 1. ä¸­å¥–é€šçŸ¥
```
ğŸ‰ æ­å–œä¸­å¥–ï¼

å•†å“ï¼šiPhone 15 Pro
ä¸­å¥–å·ç ï¼š10000042
æ‚¨å·²æˆåŠŸä¸­å¥–ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¡«å†™æ”¶è´§åœ°å€ã€‚

[å¡«å†™åœ°å€] [æŸ¥çœ‹è®¢å•]
```

### 2. å‘è´§é€šçŸ¥
```
ğŸ“¦ æ‚¨çš„è®¢å•å·²å‘è´§

è®¢å•ç¼–å·ï¼šORD20250129001
å•†å“ï¼šiPhone 15 Pro
ç‰©æµå…¬å¸ï¼šé¡ºä¸°é€Ÿè¿
è¿å•å·ï¼šSF1234567890

[æŸ¥çœ‹ç‰©æµ] [è”ç³»å®¢æœ]
```

### 3. æç°å®¡æ ¸é€šçŸ¥
```
ğŸ’° æç°å®¡æ ¸ç»“æœ

æç°é‡‘é¢ï¼š100 TJS
å®¡æ ¸çŠ¶æ€ï¼šå·²é€šè¿‡ âœ…
é¢„è®¡åˆ°è´¦æ—¶é—´ï¼š24å°æ—¶å†…

[æŸ¥çœ‹è®°å½•]
```

### 4. å……å€¼æˆåŠŸé€šçŸ¥
```
ğŸ’³ å……å€¼æˆåŠŸ

å……å€¼é‡‘é¢ï¼š50 TJS
è·å¾—å¤ºå®å¸ï¼š50 å¸
å½“å‰ä½™é¢ï¼š120 å¸

[å¼€å§‹å¤ºå®]
```

## å…­ã€æµ‹è¯•BotåŠŸèƒ½

### æµ‹è¯•æ­¥éª¤

1. **æµ‹è¯•ç”¨æˆ·æ³¨å†Œ**
   ```bash
   # åœ¨Telegramä¸­
   -> æœç´¢ @ä½ çš„botç”¨æˆ·å
   -> ç‚¹å‡» START
   -> æ£€æŸ¥æ˜¯å¦æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯
   ```

2. **æµ‹è¯•ä½™é¢æŸ¥è¯¢**
   ```bash
   -> è¾“å…¥ /balance
   -> æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºï¼š50å¤ºå®å¸ã€0å¹³å°ä½™é¢
   ```

3. **æµ‹è¯•Webç«¯è·³è½¬**
   ```bash
   -> ç‚¹å‡» "è¿›å…¥å¹¸è¿é›†å¸‚" æŒ‰é’®
   -> æ£€æŸ¥æ˜¯å¦æ‰“å¼€ http://47.243.83.253:3000
   ```

4. **æµ‹è¯•ç®¡ç†åå°**
   ```bash
   # åœ¨Webç«¯
   -> è®¿é—® http://47.243.83.253:3000/admin
   -> ç™»å½•: admin / admin123456
   -> æŸ¥çœ‹ç”¨æˆ·ç®¡ç† -> åº”è¯¥çœ‹åˆ°æ–°æ³¨å†Œçš„ç”¨æˆ·
   ```

5. **æµ‹è¯•å•†å“å‚ä¸**
   ```bash
   # åœ¨Webç«¯
   -> é€‰æ‹©ä¸€ä¸ªå•†å“ -> ç‚¹å‡»è¯¦æƒ…
   -> é€‰æ‹©ä»½æ•° -> ç‚¹å‡»"ç«‹å³å‚ä¸"
   -> æ£€æŸ¥æ˜¯å¦æ‰£é™¤å¤ºå®å¸ã€åˆ†é…å·ç 
   ```

6. **æ£€æŸ¥æ•°æ®åº“**
   ```bash
   # ç™»å½•æœåŠ¡å™¨
   ssh root@47.243.83.253
   cd /var/www/luckymart-tj
   
   # è¿è¡ŒPrisma Studioï¼ˆå›¾å½¢åŒ–æŸ¥çœ‹æ•°æ®ï¼‰
   npx prisma studio
   # æˆ–ä½¿ç”¨SQLæŸ¥è¯¢
   # è¿æ¥åˆ°Supabase PostgreSQLå¹¶æŸ¥è¯¢usersè¡¨
   ```

## ä¸ƒã€å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šBotæ— å“åº”

**ç—‡çŠ¶**ï¼šå‘é€ `/start` æ²¡æœ‰å›å¤

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥Botè¿›ç¨‹çŠ¶æ€
pm2 list
pm2 logs luckymart-bot --lines 50

# 2. æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /var/www/luckymart-tj/.env.local | grep TELEGRAM

# 3. æµ‹è¯•Bot Tokenæ˜¯å¦æœ‰æ•ˆ
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getMe
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¦‚æœè¿›ç¨‹stoppedï¼š`pm2 restart luckymart-bot`
- å¦‚æœTokenæ— æ•ˆï¼šåœ¨BotFatheré‡æ–°ç”ŸæˆTokenï¼Œæ›´æ–°.env.local
- å¦‚æœç½‘ç»œé”™è¯¯ï¼šæ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™

### é—®é¢˜2ï¼šç”¨æˆ·åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**ï¼šBotå“åº”ä½†æ•°æ®åº“æ²¡æœ‰ç”¨æˆ·è®°å½•

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æŸ¥çœ‹Botæ—¥å¿—ä¸­çš„é”™è¯¯
pm2 logs luckymart-bot --lines 100 | grep "error"

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
cd /var/www/luckymart-tj
npx ts-node -e "
import { prisma } from './lib/prisma';
prisma.users.count().then(count => console.log('ç”¨æˆ·æ•°:', count));
"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥DATABASE_URLé…ç½®
- ç¡®è®¤Prisma clientå·²ç”Ÿæˆï¼š`npx prisma generate`
- æ£€æŸ¥æ•°æ®åº“Schemaï¼š`npx prisma db push`

### é—®é¢˜3ï¼šWebç«¯å’ŒBotç”¨æˆ·ä¸åŒæ­¥

**ç—‡çŠ¶**ï¼šBotåˆ›å»ºäº†ç”¨æˆ·ï¼Œä½†Webç«¯ç™»å½•å¤±è´¥

**åŸå› **ï¼šBotåˆ›å»ºç”¨æˆ·æ—¶æ²¡æœ‰ç”ŸæˆJWT token

**è§£å†³æ–¹æ¡ˆ**ï¼š
- Webç«¯éœ€è¦ä½¿ç”¨Telegram IDç™»å½•
- æˆ–åœ¨ç”¨æˆ·è¡¨æ·»åŠ passwordå­—æ®µï¼ŒBotåˆ›å»ºç”¨æˆ·æ—¶ç”Ÿæˆé»˜è®¤å¯†ç 

## å…«ã€Botä»£ç ç»“æ„

### æ–‡ä»¶ä½ç½®
```
luckymart-tj/
â”œâ”€â”€ bot/
â”‚   â””â”€â”€ index.ts           # Botä¸»æ–‡ä»¶
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ prisma.ts          # æ•°æ®åº“å®¢æˆ·ç«¯
â”‚   â””â”€â”€ auth.ts            # è®¤è¯å·¥å…·
â””â”€â”€ .env.local             # ç¯å¢ƒå˜é‡
```

### å…³é”®ä»£ç 

**ç”¨æˆ·æ³¨å†Œé€»è¾‘** (bot/index.ts)ï¼š
```typescript
bot.command('start', async (ctx) => {
  const telegramId = ctx.from.id;
  const username = ctx.from.username;
  const firstName = ctx.from.first_name;

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
  let user = await prisma.users.findUnique({
    where: { telegramId: BigInt(telegramId) }
  });

  // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
  if (!user) {
    user = await prisma.users.create({
      data: {
        telegramId: BigInt(telegramId),
        username: username || `user_${telegramId}`,
        firstName: firstName || '',
        balance: 50,  // æ–°ç”¨æˆ·èµ é€50å¸
        freeDailyCount: 3,
        language: 'zh'
      }
    });
  }

  // å‘é€æ¬¢è¿æ¶ˆæ¯
  await ctx.reply('æ¬¢è¿æ¥åˆ°LuckyMart TJï¼', ...);
});
```

## ä¹ã€ä¸‹ä¸€æ­¥

1. **é…ç½®Bot Webhookï¼ˆå¯é€‰ï¼‰**
   - å½“å‰ä½¿ç”¨Long Polling
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Webhookæé«˜æ€§èƒ½

2. **æ·»åŠ æ›´å¤šBotå‘½ä»¤**
   - `/lottery` - å¿«é€Ÿå‚ä¸å¤ºå®
   - `/winners` - æŸ¥çœ‹æœ€è¿‘ä¸­å¥–è®°å½•
   - `/invite` - é‚€è¯·å¥½å‹èµšå¥–åŠ±

3. **å®Œå–„é€šçŸ¥æ¨é€**
   - ç¡®ä¿Edge Functionæ­£ç¡®è°ƒç”¨Bot APIæ¨é€æ¶ˆæ¯
   - æµ‹è¯•æ‰€æœ‰é€šçŸ¥åœºæ™¯

4. **ç›‘æ§å’Œæ—¥å¿—**
   - è®¾ç½®PM2ç›‘æ§å‘Šè­¦
   - é›†æˆæ—¥å¿—åˆ†æå·¥å…·

## åã€è”ç³»æ–¹å¼

- **æŠ€æœ¯æ–‡æ¡£**: `/workspace/docs/complete_technical_document.md`
- **APIæ–‡æ¡£**: `/workspace/luckymart-tj/README.md`
- **éƒ¨ç½²æ–‡æ¡£**: `/workspace/ALIYUN_DEPLOYMENT_GUIDE.md`

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-10-29
**ç‰ˆæœ¬**: v1.0
