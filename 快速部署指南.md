# LuckyMart TJ 移动端优化 - 快速部署指南

## 📋 部署方式选择

由于workspace SSH工具限制，提供**3种部署方式**供您选择：

---

## 🚀 方式1：SCP上传部署（推荐）

### Step 1: 下载部署包
从workspace下载文件：
```
/workspace/luckymart-tj/mobile_optimization_files.tar.gz  (20KB)
```

### Step 2: 上传到服务器
```bash
# 在您的本地电脑执行
scp /path/to/mobile_optimization_files.tar.gz root@47.243.83.253:/tmp/
# 密码: Lingjiu123@
```

### Step 3: SSH登录并部署
```bash
ssh root@47.243.83.253
# 密码: Lingjiu123@

# 解压部署包
cd /tmp
tar -xzf mobile_optimization_files.tar.gz

# 进入项目目录
cd /var/www/luckymart-tj

# 备份当前代码
mkdir -p ~/backup-mobile-$(date +%s)
cp -r components app types contexts prisma ~/backup-mobile-$(date +%s)/

# 复制优化文件
cp -f /tmp/components/*.tsx ./components/
cp -f /tmp/app/page.tsx ./app/
cp -f /tmp/app/product/\[id\]/page.tsx ./app/product/[id]/
cp -f /tmp/app/admin/products/create/page.tsx ./app/admin/products/create/
cp -f /tmp/types/index.ts ./types/
cp -f /tmp/contexts/LanguageContext.tsx ./contexts/
cp -f /tmp/prisma/schema.prisma ./prisma/

# 生成Prisma客户端
npx prisma generate

# 重启服务
pm2 restart luckymart-web

# 验证部署
pm2 status
pm2 logs luckymart-web --lines 20
```

---

## ⚡ 方式2：一键部署脚本

### Step 1: 下载部署包（同上）

### Step 2: 上传并执行脚本
```bash
# 上传部署包
scp mobile_optimization_files.tar.gz root@47.243.83.253:/tmp/

# SSH登录
ssh root@47.243.83.253

# 解压
cd /tmp
tar -xzf mobile_optimization_files.tar.gz

# 运行部署脚本
cd /var/www/luckymart-tj
bash /tmp/deploy_mobile_optimization.sh
```

---

## 📝 方式3：手动复制粘贴（无需下载）

如果无法下载文件，可以手动复制文件内容：

### 核心文件列表
需要更新以下9个文件：

#### 1. components/MobileNavigation.tsx (新建)
```bash
# SSH登录服务器
ssh root@47.243.83.253
cd /var/www/luckymart-tj/components

# 创建文件并粘贴内容（从下方获取）
nano MobileNavigation.tsx
```
**文件内容见**: 附录A

#### 2. components/ProductImageCarousel.tsx (新建)
```bash
nano ProductImageCarousel.tsx
```
**文件内容见**: 附录B

#### 3. components/MarketingBadgeDisplay.tsx (新建)
```bash
nano MarketingBadgeDisplay.tsx
```
**文件内容见**: 附录C

#### 4-9. 其他文件
- app/page.tsx（修改）
- app/product/[id]/page.tsx（修改）
- app/admin/products/create/page.tsx（修改）
- types/index.ts（修改）
- contexts/LanguageContext.tsx（修改）
- prisma/schema.prisma（已包含字段）

**详细内容请查看**: `MOBILE_OPTIMIZATION_FINAL_DEPLOY.md`

---

## 🗄️ 数据库Migration

### ⚠️ 重要：需要Supabase授权

由于数据库migration需要Supabase project授权，有**2种执行方式**：

### 方式A：使用Prisma Migration（推荐）
```bash
cd /var/www/luckymart-tj
npx prisma migrate deploy
```

如果提示授权错误，使用方式B。

### 方式B：手动执行SQL
1. 访问Supabase控制台
2. 进入SQL Editor
3. 执行以下SQL：

```sql
-- 添加营销角标字段
ALTER TABLE products 
ADD COLUMN IF NOT EXISTS marketing_badge JSONB DEFAULT NULL;

-- 添加注释
COMMENT ON COLUMN products.marketing_badge IS 
'Marketing badge config: {type, nameZh, nameEn, nameRu, color, bgColor, position, animated}';

-- 创建GIN索引（可选，提升查询性能）
CREATE INDEX IF NOT EXISTS idx_products_marketing_badge 
ON products USING gin(marketing_badge) 
WHERE marketing_badge IS NOT NULL;

-- 验证字段已添加
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'products' 
AND column_name = 'marketing_badge';
```

---

## ✅ 部署验证

部署完成后，在手机浏览器访问：http://47.243.83.253:3000

### 验证清单
- [ ] 移动端导航 - 左上角显示汉堡菜单图标，点击弹出侧边栏
- [ ] 首页布局 - 手机端显示2列商品网格
- [ ] 商品详情 - 图片轮播功能，可左右滑动
- [ ] 营销角标 - （需在管理后台配置商品角标后测试）
- [ ] 图片性能 - 页面加载明显加快

### 测试移动端
```bash
# Chrome DevTools
F12 > Toggle Device Toolbar (Ctrl+Shift+M)
选择设备: iPhone 12 Pro (390x844)
```

---

## 🐛 故障排查

### 问题1: PM2服务重启失败
```bash
# 查看日志
pm2 logs luckymart-web --lines 50

# 重新启动
pm2 delete luckymart-web
pm2 start npm --name "luckymart-web" -- run dev
```

### 问题2: 组件未生效
```bash
# 清除缓存
cd /var/www/luckymart-tj
rm -rf .next
npx prisma generate
pm2 restart luckymart-web --update-env

# 浏览器硬刷新：Ctrl+Shift+R
```

### 问题3: Migration执行失败
```bash
# 检查Prisma连接
npx prisma migrate status

# 手动执行SQL（见上方"方式B"）
```

---

## 📊 部署完成确认

| 项目 | 状态 | 备注 |
|------|------|------|
| 代码文件已更新 | [ ] | 9个文件 |
| Migration已执行 | [ ] | marketing_badge字段 |
| Prisma客户端已生成 | [ ] | npx prisma generate |
| PM2服务已重启 | [ ] | pm2 restart |
| 移动端导航测试 | [ ] | 汉堡菜单 |
| 首页布局测试 | [ ] | 2列网格 |
| 图片轮播测试 | [ ] | 滑动切换 |

---

## 📞 需要帮助？

如遇到问题，请提供：
1. 错误日志：`pm2 logs luckymart-web --lines 100`
2. Migration状态：`npx prisma migrate status`
3. 服务状态：`pm2 status`

---

**部署时间**: $(date)  
**项目版本**: v1.0.0 Mobile Optimization  
**服务器**: 47.243.83.253:3000
