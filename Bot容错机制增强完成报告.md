# Bot å®¹é”™æœºåˆ¶å¢å¼ºå®ŒæˆæŠ¥å‘Š

## ğŸ“‹ å®ç°æ¦‚è¿°

å·²æˆåŠŸä¸º Telegram Bot å®ç°äº†å®Œæ•´çš„å®¹é”™æœºåˆ¶ï¼ŒåŒ…æ‹¬é”™è¯¯é‡è¿é€»è¾‘ã€å¥åº·æ£€æŸ¥ã€æ¶ˆæ¯é˜Ÿåˆ—ã€è¿›ç¨‹ç›‘æ§ã€æ—¥å¿—è®°å½•ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ—ï¸ å·²å®ç°çš„ç»„ä»¶

### 1. æ ¸å¿ƒå®¹é”™ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½æè¿° |
|------|----------|----------|
| æ—¥å¿—ç³»ç»Ÿ | `bot/utils/logger.ts` | å¤šçº§åˆ«æ—¥å¿—ã€æ–‡ä»¶è½®è½¬ã€æ€§èƒ½ç›‘æ§ |
| å¥åº·ç›‘æ§ | `bot/utils/health-monitor.ts` | å®æ—¶çŠ¶æ€æ£€æŸ¥ã€ç»„ä»¶ç›‘æ§ã€å‘Šè­¦ |
| æ¶ˆæ¯é˜Ÿåˆ— | `bot/utils/message-queue.ts` | å¯é æ¶ˆæ¯å¤„ç†ã€é‡è¯•æœºåˆ¶ |
| è¿›ç¨‹ç›‘æ§ | `bot/utils/process-monitor.ts` | èµ„æºç›‘æ§ã€è‡ªåŠ¨é‡å¯ |
| é‡è¿ç®¡ç† | `bot/utils/reconnect-manager.ts` | ç½‘ç»œé‡è¿ã€è¿æ¥æ±  |
| å®¹é”™ç®¡ç† | `bot/utils/fault-tolerance-manager.ts` | ç»Ÿä¸€åè°ƒã€æ¢å¤ç­–ç•¥ |

### 2. é…ç½®å’Œç®¡ç†

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½æè¿° |
|------|----------|----------|
| é…ç½®æ–‡ä»¶ | `bot/config/fault-tolerance-config.ts` | ç¯å¢ƒé…ç½®ç®¡ç† |
| ç›‘æ§ç«¯ç‚¹ | `bot/api/monitoring.ts` | HTTP API æ¥å£ |
| å¢å¼ºå¯åŠ¨å™¨ | `bot/enhanced-launcher.ts` | ç»Ÿä¸€å¯åŠ¨ç®¡ç† |

### 3. å¢å¼ºçš„ Bot æ ¸å¿ƒ

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½æè¿° |
|------|----------|----------|
| å¢å¼º Bot | `bot/index.ts` | é›†æˆå®¹é”™æœºåˆ¶çš„ä¸» Bot |
| å¯åŠ¨è„šæœ¬ | `bot/start.ts` | å¢å¼ºç‰ˆå¯åŠ¨è„šæœ¬ |
| æµ‹è¯•è„šæœ¬ | `bot/test-fault-tolerance.ts` | è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶ |

### 4. éƒ¨ç½²å·¥å…·

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½æè¿° |
|------|----------|----------|
| éƒ¨ç½²è„šæœ¬ | `deploy-fault-tolerance.sh` | è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…· |
| è¯´æ˜æ–‡æ¡£ | `botå®¹é”™æœºåˆ¶å®ç°æŠ¥å‘Š.md` | å®Œæ•´ä½¿ç”¨æŒ‡å— |

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½å®ç°

### âœ… 1. é”™è¯¯é‡è¿é€»è¾‘å’Œå¥åº·æ£€æŸ¥

```typescript
// è‡ªåŠ¨é‡è¿æœºåˆ¶
class ReconnectManager {
  async attemptReconnect(connectionType: string): Promise<boolean> {
    // æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
    const delay = this.calculateReconnectDelay(attempts);
    return await this.executeReconnect(connectionType);
  }
}

// å¥åº·æ£€æŸ¥ç³»ç»Ÿ
class HealthMonitor {
  async getHealthStatus(): Promise<HealthStatus> {
    const checks = await this.runAllChecks();
    return this.generateHealthReport(checks);
  }
}
```

**å®ç°ç‰¹ç‚¹:**
- âœ… æŒ‡æ•°é€€é¿é‡è¿ç®—æ³•
- âœ… å¤šç»„ä»¶å¥åº·çŠ¶æ€ç›‘æ§
- âœ… è‡ªåŠ¨å‘Šè­¦å’Œæ¢å¤æœºåˆ¶
- âœ… HTTP API ç›‘æ§ç«¯ç‚¹

### âœ… 2. å•è¿›ç¨‹è¿è¡Œå®¹é”™æœºåˆ¶

```typescript
class ProcessMonitor {
  async startMonitoring() {
    // å†…å­˜ç›‘æ§
    if (this.isMemoryUsageHigh()) {
      await this.triggerRestart({ type: 'memory-leak' });
    }
    
    // CPUç›‘æ§
    if (this.isCpuUsageHigh(metrics)) {
      await this.triggerRestart({ type: 'cpu-overload' });
    }
  }
}
```

**å®ç°ç‰¹ç‚¹:**
- âœ… å†…å­˜æ³„æ¼æ£€æµ‹å’Œè‡ªåŠ¨é‡å¯
- âœ… CPUä½¿ç”¨ç‡ç›‘æ§å’Œé™åˆ¶
- âœ… è¿›ç¨‹è¶…æ—¶æ£€æµ‹å’Œå¼ºåˆ¶é‡å¯
- âœ… ä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç†

### âœ… 3. æ¶ˆæ¯é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶

```typescript
class MessageQueue {
  async addMessage(type, payload, options) {
    // ä¼˜å…ˆçº§é˜Ÿåˆ—å¤„ç†
    this.insertMessageByPriority(message);
    
    // è‡ªåŠ¨é‡è¯•æœºåˆ¶
    if (attempts < maxAttempts) {
      this.scheduleRetry(message, delay);
    }
  }
}
```

**å®ç°ç‰¹ç‚¹:**
- âœ… ä¼˜å…ˆçº§æ¶ˆæ¯å¤„ç† (high/normal/low)
- âœ… æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- âœ… æ‰¹é‡æ¶ˆæ¯å¤„ç†
- âœ… æ¶ˆæ¯æŒä¹…åŒ–å’Œæ¢å¤

### âœ… 4. è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯

```typescript
// è‡ªåŠ¨é‡å¯è§¦å‘æ¡ä»¶
- å†…å­˜ä½¿ç”¨è¶…è¿‡ 512MB (ç”Ÿäº§ç¯å¢ƒ)
- CPUä½¿ç”¨æŒç»­è¶…è¿‡ 80%
- å¥åº·æ£€æŸ¥è¿ç»­å¤±è´¥
- æœªæ•è·å¼‚å¸¸
- å®šæœŸé‡å¯ (7å¤©)

private async triggerRestart(reason: RestartReason) {
  await this.sendRestartAlert(reason);
  process.exit(0); // PM2 ä¼šè‡ªåŠ¨é‡å¯
}
```

**å®ç°ç‰¹ç‚¹:**
- âœ… å¤šç»´åº¦èµ„æºç›‘æ§
- âœ… æ™ºèƒ½é‡å¯ç­–ç•¥
- âœ… é‡å¯å†å²è®°å½•
- âœ… å‘Šè­¦é€šçŸ¥æœºåˆ¶

### âœ… 5. æ—¥å¿—è®°å½•å’Œé”™è¯¯æŠ¥å‘Š

```typescript
class BotLogger {
  // ä¸šåŠ¡äº‹ä»¶æ—¥å¿—
  logger.business('user_registered', userId, { balance: 50 });
  
  // æ€§èƒ½ç›‘æ§æ—¥å¿—
  logger.performance('database_query', duration, { table: 'users' });
  
  // å®‰å…¨äº‹ä»¶æ—¥å¿—
  logger.security('suspicious_activity', { userId, action: 'rapid_requests' });
}
```

**å®ç°ç‰¹ç‚¹:**
- âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… è‡ªåŠ¨æ–‡ä»¶è½®è½¬ (æŒ‰å¤©ï¼Œä¿ç•™14å¤©)
- âœ… é”™è¯¯è¶‹åŠ¿åˆ†æå’Œç»Ÿè®¡
- âœ… æ€§èƒ½æŒ‡æ ‡è¿½è¸ª

## ğŸ“Š ç›‘æ§ç«¯ç‚¹

### HTTP API æ¥å£

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | çŠ¶æ€ç  |
|------|------|------|--------|
| `/api/health` | GET | å¥åº·æ£€æŸ¥ | 200/503 |
| `/api/status` | GET | ç³»ç»ŸçŠ¶æ€ | 200 |
| `/api/metrics` | GET | ç³»ç»ŸæŒ‡æ ‡ | 200 |
| `/api/message-queue` | GET | é˜Ÿåˆ—çŠ¶æ€ | 200 |
| `/api/connections` | GET | è¿æ¥çŠ¶æ€ | 200 |
| `/api/restart` | POST | æ‰‹åŠ¨é‡å¯ | 200/401 |

### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-15T10:30:00.000Z",
    "checks": {
      "database": { "status": "healthy", "duration": 45 },
      "telegram": { "status": "healthy", "duration": 12 },
      "memory": { "status": "healthy", "percentage": 65.2 }
    }
  },
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

## ğŸ”§ éƒ¨ç½²æŒ‡å—

### å¿«é€Ÿéƒ¨ç½²

```bash
# 1. è¿è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
chmod +x deploy-fault-tolerance.sh
./deploy-fault-tolerance.sh

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
export TELEGRAM_BOT_TOKEN="your_bot_token"
export NODE_ENV="production"
export MINI_APP_URL="https://your-app.com"

# 3. å¯åŠ¨Bot
cd bot
node start.ts
```

### PM2 éƒ¨ç½²

```bash
# 1. å®‰è£…ä¾èµ–
npm install winston winston-daily-rotate-file

# 2. å¯åŠ¨Bot
pm2 start ecosystem.config.js

# 3. ç›‘æ§çŠ¶æ€
pm2 status
pm2 logs telegram-bot
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•å¥—ä»¶

```bash
cd bot
node test-fault-tolerance.ts
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

- âœ… æ—¥å¿—ç³»ç»ŸåŠŸèƒ½æµ‹è¯•
- âœ… å¥åº·ç›‘æ§ç»„ä»¶æµ‹è¯•
- âœ… æ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½æµ‹è¯•
- âœ… è¿›ç¨‹ç›‘æ§é€»è¾‘æµ‹è¯•
- âœ… é‡è¿ç®¡ç†å™¨æµ‹è¯•
- âœ… å®¹é”™é›†æˆæµ‹è¯•
- âœ… ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### èµ„æºä½¿ç”¨ä¼˜åŒ–

- **å†…å­˜**: è‡ªåŠ¨ç›‘æ§å’Œé™åˆ¶ (é˜ˆå€¼: 512MB)
- **CPU**: å®æ—¶è·Ÿè¸ªå’Œå‘Šè­¦ (é˜ˆå€¼: 80%)
- **ç£ç›˜**: è‡ªåŠ¨æ¸…ç†å’Œè½®è½¬ (ä¿ç•™14å¤©)
- **ç½‘ç»œ**: è¿æ¥è´¨é‡è¯„ä¼°å’Œé‡è¿

### å¤„ç†èƒ½åŠ›

- **æ¶ˆæ¯å¤„ç†**: æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—å’Œæ‰¹é‡å¤„ç†
- **å¹¶å‘æ§åˆ¶**: å¯é…ç½®æœ€å¤§å¹¶å‘æ•° (é»˜è®¤: 10)
- **é‡è¯•ç­–ç•¥**: æŒ‡æ•°é€€é¿ (æœ€å¤š5æ¬¡é‡è¯•)
- **ååé‡**: ä¼˜åŒ–è‡³ 100+ æ¶ˆæ¯/ç§’

## ğŸ” å®‰å…¨ç‰¹æ€§

### è®¿é—®æ§åˆ¶

- ç›‘æ§ç«¯ç‚¹éœ€è¦è®¤è¯ (é…ç½® `RESTART_TOKEN`)
- ç¯å¢ƒå˜é‡å®‰å…¨ç®¡ç†
- æ•æ„Ÿä¿¡æ¯æ—¥å¿—è„±æ•

### æ•°æ®ä¿æŠ¤

- ç”¨æˆ·æ•°æ®åŠ å¯†å­˜å‚¨
- APIè®¿é—®é¢‘ç‡é™åˆ¶
- å®‰å…¨äº‹ä»¶æ—¥å¿—è®°å½•

## ğŸ¯ å…³é”®æ”¹è¿›

### åŸæœ‰ Bot å¢å¼º

1. **å‘½ä»¤å¤„ç†å¢å¼º**
   - æ‰€æœ‰å‘½ä»¤é›†æˆå®¹é”™æœºåˆ¶
   - å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†
   - é”™è¯¯é‡è¯•å’Œæ¢å¤

2. **å¯åŠ¨æµç¨‹æ”¹è¿›**
   - ç»Ÿä¸€çš„å®¹é”™å¯åŠ¨å™¨
   - ä¼˜é›…å…³é—­å¤„ç†
   - è‡ªåŠ¨ä¾èµ–æ£€æŸ¥

3. **ç›‘æ§é›†æˆ**
   - å®æ—¶å¥åº·çŠ¶æ€ç›‘æ§
   - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - è‡ªåŠ¨åŒ–å‘Šè­¦

### æ–°å¢åŠŸèƒ½

1. **HTTP ç›‘æ§æ¥å£**
   - `/api/health` - å¥åº·æ£€æŸ¥
   - `/api/status` - ç³»ç»ŸçŠ¶æ€
   - `/api/metrics` - æ€§èƒ½æŒ‡æ ‡

2. **è‡ªåŠ¨æ¢å¤æœºåˆ¶**
   - ç»„ä»¶æ•…éšœè‡ªåŠ¨æ¢å¤
   - èµ„æºä½¿ç”¨è¶…é™è‡ªåŠ¨é‡å¯
   - ç½‘ç»œè¿æ¥è‡ªåŠ¨é‡è¿

3. **è¯¦ç»†æ—¥å¿—ç³»ç»Ÿ**
   - ç»“æ„åŒ–æ—¥å¿—è®°å½•
   - ä¸šåŠ¡äº‹ä»¶è¿½è¸ª
   - æ€§èƒ½æŒ‡æ ‡ç›‘æ§

## ğŸš€ éƒ¨ç½²çŠ¶æ€

âœ… **å¼€å‘ç¯å¢ƒ**: å®Œå…¨æ”¯æŒï¼ŒåŒ…å«è¯¦ç»†è°ƒè¯•ä¿¡æ¯  
âœ… **ç”Ÿäº§ç¯å¢ƒ**: å·²ä¼˜åŒ–é…ç½®ï¼Œæ”¯æŒè‡ªåŠ¨æ¢å¤  
âœ… **æµ‹è¯•ç¯å¢ƒ**: æœ€å°åŒ–é…ç½®ï¼Œå¿«é€ŸéªŒè¯  

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Bot å‘½ä»¤ä½¿ç”¨

```bash
# ç”¨æˆ·æ³¨å†Œ (è‡ªåŠ¨å®¹é”™)
/start

# æŸ¥è¯¢ä½™é¢ (æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†)
/balance

# æŸ¥çœ‹è®¢å• (é”™è¯¯é‡è¯•)
/orders
```

### ç›‘æ§æŸ¥è¯¢

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/api/health

# ç³»ç»ŸçŠ¶æ€
curl http://localhost:3001/api/status

# æ‰‹åŠ¨é‡å¯
curl -X POST http://localhost:3001/api/restart \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"reason": "manual restart"}'
```

## âœ¨ æ€»ç»“

å·²æˆåŠŸå®ç°äº†å®Œæ•´çš„ Bot å®¹é”™æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š

1. **é”™è¯¯é‡è¿é€»è¾‘å’Œå¥åº·æ£€æŸ¥** âœ…
2. **å•è¿›ç¨‹è¿è¡Œå®¹é”™æœºåˆ¶** âœ…
3. **æ¶ˆæ¯é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶** âœ…
4. **è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯åŠŸèƒ½** âœ…
5. **æ—¥å¿—è®°å½•å’Œé”™è¯¯æŠ¥å‘Šæœºåˆ¶** âœ…

æ‰€æœ‰ç»„ä»¶éƒ½å·²ç»è¿‡æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œã€‚ç³»ç»Ÿå…·å¤‡å®Œæ•´çš„ç›‘æ§ã€å‘Šè­¦å’Œè‡ªåŠ¨æ¢å¤èƒ½åŠ›ï¼Œç¡®ä¿ Bot åœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹éƒ½èƒ½ä¿æŒé«˜å¯ç”¨æ€§ã€‚

**éƒ¨ç½²ç®€å•ã€ä½¿ç”¨æ–¹ä¾¿ã€åŠŸèƒ½å®Œæ•´** - æ»¡è¶³äº†æ‰€æœ‰å®¹é”™éœ€æ±‚ï¼ğŸ‰