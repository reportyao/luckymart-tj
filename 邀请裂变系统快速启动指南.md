# é‚€è¯·è£‚å˜ç³»ç»Ÿå¿«é€Ÿå¯åŠ¨æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ•°æ®åº“éƒ¨ç½²

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd luckymart-tj

# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
psql -d your_database -f supabase/migrations/1762000000_create_invitation_system.sql

# 3. (å¯é€‰) åŠ è½½æµ‹è¯•æ•°æ®
psql -d your_database -f test/init-invitation-test-data.sql
```

### 2. ç¯å¢ƒé…ç½®

ç¡®ä¿åœ¨ `.env.local` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql://user:password@localhost:5432/luckymart_tj

# JWTå¯†é’¥
JWT_SECRET=your-super-secret-jwt-key
JWT_REFRESH_SECRET=your-super-secret-refresh-key

# åº”ç”¨é…ç½®
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development
```

### 3. éªŒè¯éƒ¨ç½²

è®¿é—®ä»¥ä¸‹å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„
curl -X GET http://localhost:3000/api/health

# æµ‹è¯•é‚€è¯·ç ç”ŸæˆåŠŸèƒ½ï¼ˆéœ€è¦å…ˆè·å–JWT tokenï¼‰
curl -X POST http://localhost:3000/api/invitation/generate-code \
  -H "Authorization: Bearer your-jwt-token"
```

## ğŸ“ API å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨APIè°ƒç”¨ç¤ºä¾‹

#### 1. ç”Ÿæˆé‚€è¯·ç 
```bash
curl -X POST /api/invitation/generate-code \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 2. è·å–é‚€è¯·ä¿¡æ¯
```bash
curl -X GET /api/invitation/my-code \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 3. ç»‘å®šé‚€è¯·å…³ç³»
```bash
curl -X POST /api/invitation/bind \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"referralCode": "LM123456"}'
```

#### 4. æŸ¥çœ‹å¥–åŠ±è®°å½•
```bash
curl -X GET "/api/invitation/rewards?page=1&limit=20&status=available" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5. é¢†å–å¥–åŠ±
```bash
curl -X POST /api/invitation/claim-reward \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"rewardIds": ["reward-uuid-1", "reward-uuid-2"]}'
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æœ¬åœ°å¼€å‘

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# 3. è¿è¡Œæµ‹è¯•
npm test

# 4. ç±»å‹æ£€æŸ¥
npm run type-check
```

### ä»£ç ç»“æ„

```
app/api/invitation/
â”œâ”€â”€ generate-code/     # ç”Ÿæˆé‚€è¯·ç 
â”œâ”€â”€ my-code/          # è·å–é‚€è¯·ä¿¡æ¯
â”œâ”€â”€ bind/             # ç»‘å®šé‚€è¯·å…³ç³»
â”œâ”€â”€ rewards/          # å¥–åŠ±è®°å½•
â”œâ”€â”€ commission/       # è¿”åˆ©è®°å½•
â””â”€â”€ claim-reward/     # é¢†å–å¥–åŠ±
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm test invitation-api.test.ts

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage
```

### æµ‹è¯•æ•°æ®

ä½¿ç”¨æµ‹è¯•æ•°æ®ï¼š
```bash
psql -d your_database -f test/init-invitation-test-data.sql
```

æµ‹è¯•ç”¨æˆ·ä¿¡æ¯ï¼š
- é‚€è¯·äºº: `test_inviter_001`
- è¢«é‚€è¯·äºº: `test_invited_001`, `test_invited_002`
- é‚€è¯·ç : `LM100001`, `LM100002`, `LM100003`

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥APIæœåŠ¡çŠ¶æ€
curl http://localhost:3000/api/health

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
curl http://localhost:3000/api/health/database
```

### æ—¥å¿—ç›‘æ§

æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š
```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
pm2 logs luckymart-tj
```

### æ€§èƒ½ç›‘æ§

å…³é”®æŒ‡æ ‡ï¼š
- APIå“åº”æ—¶é—´ < 200ms
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ < 100ms
- å†…å­˜ä½¿ç”¨ < 512MB
- CPUä½¿ç”¨ç‡ < 50%

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. æ•°æ®åº“è¿æ¥å¤±è´¥**
```bash
# æ£€æŸ¥æ•°æ®åº“æœåŠ¡
ps aux | grep postgres

# æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²
echo $DATABASE_URL
```

**2. JWTè®¤è¯å¤±è´¥**
```bash
# æ£€æŸ¥JWTå¯†é’¥é…ç½®
echo $JWT_SECRET

# éªŒè¯tokenæ ¼å¼
curl -v http://localhost:3000/api/invitation/my-code \
  -H "Authorization: Bearer INVALID_TOKEN"
```

**3. é‚€è¯·ç æ ¼å¼é”™è¯¯**
- æ­£ç¡®æ ¼å¼: `LM123456`
- é”™è¯¯æ ¼å¼: `lm123456`, `XM123456`, `LM12345`

**4. å¥–åŠ±é¢†å–å¤±è´¥**
- æ£€æŸ¥å¥–åŠ±çŠ¶æ€æ˜¯å¦ä¸º `available`
- ç¡®è®¤å¥–åŠ±æœªè¿‡æœŸ
- éªŒè¯å¥–åŠ±æ‰€æœ‰æƒ

### è°ƒè¯•å·¥å…·

**1. æ•°æ®åº“æŸ¥è¯¢**
```sql
-- æŸ¥çœ‹é‚€è¯·å…³ç³»
SELECT * FROM referral_relationships;

-- æŸ¥çœ‹å¥–åŠ±è®°å½•
SELECT * FROM invitation_rewards WHERE is_claimed = false;

-- æŸ¥çœ‹ç”¨æˆ·é‚€è¯·ç 
SELECT id, referral_code FROM users WHERE referral_code IS NOT NULL;
```

**2. APIè°ƒè¯•**
```bash
# è¯¦ç»†è¯·æ±‚æ—¥å¿—
curl -v -X POST /api/invitation/generate-code \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

```sql
-- æŸ¥çœ‹æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE SELECT * FROM invitation_rewards 
WHERE referrer_user_id = 'user-id' 
ORDER BY created_at DESC 
LIMIT 20;

-- é‡å»ºç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
REINDEX TABLE invitation_rewards;
```

### ç¼“å­˜ç­–ç•¥

å»ºè®®å¯¹ä»¥ä¸‹æ•°æ®è¿›è¡Œç¼“å­˜ï¼š
- ç”¨æˆ·é‚€è¯·ç»Ÿè®¡ä¿¡æ¯ (5åˆ†é’Ÿç¼“å­˜)
- é‚€è¯·ç ä¿¡æ¯ (1å°æ—¶ç¼“å­˜)
- å¥–åŠ±è®°å½•åˆ—è¡¨ (2åˆ†é’Ÿç¼“å­˜)

### ç›‘æ§å‘Šè­¦

è®¾ç½®ä»¥ä¸‹å‘Šè­¦ï¼š
- APIå“åº”æ—¶é—´ > 500ms
- é”™è¯¯ç‡ > 5%
- æ•°æ®åº“è¿æ¥æ•° > 80%
- å†…å­˜ä½¿ç”¨ > 80%

## ğŸ¯ ç”Ÿäº§éƒ¨ç½²

### ç¯å¢ƒå‡†å¤‡

```bash
# 1. è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
export NODE_ENV=production
export DATABASE_URL=postgresql://prod_user:pass@prod_host:5432/prod_db
export JWT_SECRET=production-secret-key

# 2. æ„å»ºåº”ç”¨
npm run build

# 3. è¿è¡Œæ•°æ®åº“è¿ç§»
psql -d production_db -f supabase/migrations/1762000000_create_invitation_system.sql
```

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»å·²å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] JWTå¯†é’¥å·²è®¾ç½®
- [ ] SSLè¯ä¹¦å·²é…ç½®
- [ ] ç›‘æ§å‘Šè­¦å·²è®¾ç½®
- [ ] å¤‡ä»½ç­–ç•¥å·²åˆ¶å®š

### æ‰©å®¹å»ºè®®

å½“ç”¨æˆ·é‡å¢é•¿æ—¶ï¼š

1. **æ•°æ®åº“ä¼˜åŒ–**
   - å¢åŠ è¿æ¥æ± å¤§å°
   - ä¼˜åŒ–æ…¢æŸ¥è¯¢
   - è€ƒè™‘è¯»å†™åˆ†ç¦»

2. **åº”ç”¨å±‚ä¼˜åŒ–**
   - å¢åŠ æœåŠ¡å™¨å®ä¾‹
   - é…ç½®è´Ÿè½½å‡è¡¡
   - å¯ç”¨CDNåŠ é€Ÿ

3. **ç¼“å­˜å±‚**
   - é›†æˆRedisç¼“å­˜
   - å®æ–½åˆ†å¸ƒå¼ç¼“å­˜
   - é…ç½®ç¼“å­˜é¢„çƒ­

## ğŸ“ æ”¯æŒè”ç³»

### æ–‡æ¡£èµ„æº

- [APIå®Œæ•´æ–‡æ¡£](./docs/invitation-system-api.md)
- [ä½¿ç”¨ç¤ºä¾‹](./examples/invitation-api-examples.ts)
- [æµ‹è¯•æ–‡ä»¶](./__tests__/invitation-api.test.ts)
- [å®ŒæˆæŠ¥å‘Š](./é‚€è¯·è£‚å˜APIå¼€å‘å®ŒæˆæŠ¥å‘Š.md)

### æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ’æŸ¥ï¼š
1. æŸ¥çœ‹APIæ–‡æ¡£å’Œç¤ºä¾‹
2. æ£€æŸ¥æµ‹è¯•æ–‡ä»¶ä¸­çš„ç”¨æ³•
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
4. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

---

**ğŸš€ ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒå®Œæ•´æ–‡æ¡£æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚**