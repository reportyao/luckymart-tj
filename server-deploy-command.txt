#!/bin/bash

echo "ğŸš€ å¼€å§‹æœåŠ¡å™¨éƒ¨ç½² LuckyMart TJ ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæœ¬..."
echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
echo ""

# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
echo "ğŸ“ 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
BACKUP_DIR="/var/backups/luckymart-tj-$(date +%Y%m%d-%H%M%S)"
mkdir -p $BACKUP_DIR
if [ -d "/var/www/luckymart-tj" ]; then
    cp -r /var/www/luckymart-tj/* $BACKUP_DIR/ 2>/dev/null || true
    echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
fi

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
echo "ğŸ“‚ 2. è¿›å…¥é¡¹ç›®ç›®å½•..."
cd /var/www/luckymart-tj

# 3. æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ 3. æ‹‰å–GitHubæœ€æ–°ä»£ç ..."
git pull origin main

# 4. å®‰è£…ä¾èµ–
echo "ğŸ”§ 4. å®‰è£…ä¾èµ–..."
npm install

# 5. æ•°æ®åº“è¿ç§»
echo "ğŸ—„ï¸ 5. æ•°æ®åº“è¿ç§»..."
npx prisma generate
npx prisma db push

# 6. æ„å»ºé¡¹ç›®
echo "âš¡ 6. æ„å»ºé¡¹ç›®..."
npm run build

# 7. é‡å¯æœåŠ¡
echo "ğŸ”„ 7. é‡å¯æœåŠ¡..."
pm2 restart luckymart-tj || pm2 start npm --name "luckymart-tj" -- start

# 8. æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ“Š 8. æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
pm2 status
systemctl status nginx --no-pager -l

# 9. å¥åº·æ£€æŸ¥
echo "ğŸ” 9. å¥åº·æ£€æŸ¥..."
curl -f http://localhost:3000/health || echo "âš ï¸ ä¸»ç«™å¥åº·æ£€æŸ¥å¤±è´¥"
curl -f http://localhost:3000/api/monitoring/health || echo "âš ï¸ APIå¥åº·æ£€æŸ¥å¤±è´¥"

echo ""
echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“ éƒ¨ç½²æ‘˜è¦:"
echo "   - ä»£ç å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
echo "   - ä¾èµ–å·²å®‰è£…å¹¶æ„å»º"
echo "   - æ•°æ®åº“è¿ç§»å®Œæˆ"
echo "   - æœåŠ¡å·²é‡å¯"
echo "   - å¤‡ä»½ä¿å­˜åœ¨: $BACKUP_DIR"
echo ""
echo "ğŸ”— è®¿é—®åœ°å€:"
echo "   - ç½‘ç«™: http://47.243.83.253:3000"
echo "   - ç®¡ç†åå°: http://47.243.83.253:3000/admin"
echo ""
echo "âš ï¸  å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥:"
echo "   - PM2æ—¥å¿—: pm2 logs"
echo "   - Nginxæ—¥å¿—: tail -f /var/log/nginx/error.log"
echo "   - ç³»ç»Ÿæ—¥å¿—: journalctl -u nginx"