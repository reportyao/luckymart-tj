# Telegram Bot å®¹é”™æœºåˆ¶å®ç°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®ä¸º Telegram Bot å®ç°äº†å®Œæ•´çš„å®¹é”™æœºåˆ¶ï¼Œç¡®ä¿ Bot åœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹èƒ½å¤Ÿç¨³å®šè¿è¡Œï¼Œè‡ªåŠ¨æ¢å¤ï¼Œå¹¶æä¾›è¯¦ç»†çš„ç›‘æ§å’Œå‘Šè­¦åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ¶æ„ç»„æˆ

### æ ¸å¿ƒç»„ä»¶

1. **æ—¥å¿—ç³»ç»Ÿ** (`utils/logger.ts`)
   - å¤šçº§åˆ«æ—¥å¿—è®°å½• (ERROR, WARN, INFO, DEBUG)
   - æ–‡ä»¶è½®è½¬å’Œè‡ªåŠ¨æ¸…ç†
   - æ€§èƒ½ç›‘æ§å’Œä¸šåŠ¡äº‹ä»¶è¿½è¸ª
   - é”™è¯¯ç»Ÿè®¡å’Œåˆ†æ

2. **å¥åº·ç›‘æ§ç³»ç»Ÿ** (`utils/health-monitor.ts`)
   - å®æ—¶å¥åº·çŠ¶æ€æ£€æŸ¥
   - ç»„ä»¶çŠ¶æ€ç›‘æ§ (æ•°æ®åº“ã€Telegramã€å†…å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰)
   - è‡ªåŠ¨å‘Šè­¦å’Œæ¢å¤æœºåˆ¶
   - HTTP API ç«¯ç‚¹æ”¯æŒ

3. **æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ** (`utils/message-queue.ts`)
   - å¯é çš„æ¶ˆæ¯å¤„ç†
   - ä¼˜å…ˆçº§é˜Ÿåˆ—ç®¡ç†
   - è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯æ¢å¤
   - æ‰¹é‡æ¶ˆæ¯å¤„ç†

4. **è¿›ç¨‹ç›‘æ§å™¨** (`utils/process-monitor.ts`)
   - è¿›ç¨‹çŠ¶æ€å®æ—¶ç›‘æ§
   - å†…å­˜å’ŒCPUä½¿ç”¨è·Ÿè¸ª
   - è‡ªåŠ¨é‡å¯æœºåˆ¶
   - ä¼˜é›…å…³é—­å¤„ç†

5. **é‡è¿ç®¡ç†å™¨** (`utils/reconnect-manager.ts`)
   - ç½‘ç»œè¿æ¥ç›‘æ§
   - æŒ‡æ•°é€€é¿é‡è¿ç­–ç•¥
   - è¿æ¥æ± ç®¡ç†
   - è¿æ¥è´¨é‡è¯„ä¼°

6. **å®¹é”™ç®¡ç†å™¨** (`utils/fault-tolerance-manager.ts`)
   - ç»Ÿä¸€å®¹é”™ç­–ç•¥ç®¡ç†
   - æ¢å¤ç­–ç•¥åè°ƒ
   - ç³»ç»Ÿäº‹ä»¶å¤„ç†
   - æ€§èƒ½ç»Ÿè®¡

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. é”™è¯¯é‡è¿é€»è¾‘å’Œå¥åº·æ£€æŸ¥

```typescript
// å¥åº·æ£€æŸ¥ç«¯ç‚¹
GET /api/health

// ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹
GET /api/status

// ç³»ç»ŸæŒ‡æ ‡ç«¯ç‚¹
GET /api/metrics
```

**åŠŸèƒ½ç‰¹ç‚¹:**
- å®æ—¶ç›‘æ§æ‰€æœ‰ç»„ä»¶å¥åº·çŠ¶æ€
- è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸å¹¶è§¦å‘æ¢å¤æµç¨‹
- æ”¯æŒé…ç½®é˜ˆå€¼å’Œå‘Šè­¦è§„åˆ™
- æä¾›è¯¦ç»†çš„çŠ¶æ€æŠ¥å‘Š

### 2. å•è¿›ç¨‹è¿è¡Œå®¹é”™æœºåˆ¶

**è¿›ç¨‹ä¿æŠ¤ç‰¹æ€§:**
- å†…å­˜æ³„æ¼æ£€æµ‹å’Œè‡ªåŠ¨é‡å¯
- CPUä½¿ç”¨ç‡ç›‘æ§å’Œé™åˆ¶
- è¿›ç¨‹è¶…æ—¶æ£€æµ‹å’Œå¼ºåˆ¶é‡å¯
- ä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç†

**é‡å¯ç­–ç•¥:**
- æŒ‰è¿è¡Œæ—¶é—´å®šæœŸé‡å¯ (é»˜è®¤7å¤©)
- èµ„æºä½¿ç”¨è¶…é™æ—¶é‡å¯
- è¿ç»­é”™è¯¯æ£€æµ‹å’Œé‡å¯
- æ‰‹åŠ¨é‡å¯æ”¯æŒ

### 3. æ¶ˆæ¯é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶

```typescript
// æ·»åŠ æ¶ˆæ¯åˆ°é˜Ÿåˆ—
await messageQueue.addMessage('telegram', {
  type: 'send_message',
  chatId: chatId,
  text: 'Hello World'
}, {
  priority: 'high',
  maxAttempts: 3,
  delay: 1000
});
```

**é˜Ÿåˆ—ç‰¹æ€§:**
- ä¼˜å…ˆçº§å¤„ç† (high, normal, low)
- æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- æ¶ˆæ¯æŒä¹…åŒ–å’Œæ¢å¤
- æ‰¹é‡å¤„ç†å’Œå¹¶å‘æ§åˆ¶

### 4. è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯

**ç›‘æ§æŒ‡æ ‡:**
- å†…å­˜ä½¿ç”¨é‡ (å †å†…å­˜ã€RSSã€å¤–éƒ¨å†…å­˜)
- CPUä½¿ç”¨ç‡ (ç”¨æˆ·æ€ã€ç³»ç»Ÿæ€)
- äº‹ä»¶å¾ªç¯å»¶è¿Ÿ
- å¥æŸ„å’Œè¯·æ±‚æ•°é‡

**é‡å¯è§¦å‘æ¡ä»¶:**
- å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼ (512MB+)
- CPUä½¿ç”¨æŒç»­è¶…è¿‡80%
- å¥åº·æ£€æŸ¥è¿ç»­å¤±è´¥
- æœªæ•è·å¼‚å¸¸

### 5. æ—¥å¿—è®°å½•å’Œé”™è¯¯æŠ¥å‘Š

```typescript
// ä¸šåŠ¡äº‹ä»¶æ—¥å¿—
logger.business('user_registered', userId, {
  username: user.username,
  initialBalance: user.balance
});

// æ€§èƒ½ç›‘æ§
logger.performance('database_query', duration, {
  operation: 'user_lookup',
  table: 'users'
});

// å®‰å…¨äº‹ä»¶
logger.security('suspicious_activity', {
  userId: userId,
  action: 'rapid_requests'
});
```

**æ—¥å¿—åŠŸèƒ½:**
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- è‡ªåŠ¨æ–‡ä»¶è½®è½¬ (æŒ‰å¤©ï¼Œä¿ç•™14å¤©)
- é”™è¯¯è¶‹åŠ¿åˆ†æå’Œç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡è¿½è¸ª

## ğŸ“Š ç›‘æ§ç«¯ç‚¹

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
curl http://localhost:3001/api/health
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-15T10:30:00.000Z",
    "uptime": 3600,
    "checks": {
      "database": {
        "status": "healthy",
        "message": "Database connection healthy",
        "duration": 45
      },
      "telegram": {
        "status": "healthy",
        "message": "Telegram configuration valid",
        "duration": 12
      }
    }
  }
}
```

### ç³»ç»ŸçŠ¶æ€ç«¯ç‚¹

```bash
curl http://localhost:3001/api/status
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": {
    "system": {
      "overall": "healthy",
      "uptime": 7200,
      "components": {
        "database": {
          "status": "healthy",
          "lastCheck": "2024-01-15T10:30:00.000Z"
        }
      }
    }
  }
}
```

### ç³»ç»ŸæŒ‡æ ‡ç«¯ç‚¹

```bash
curl http://localhost:3001/api/metrics
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": {
    "system": {
      "uptime": 3600,
      "memory": {
        "heapUsed": 50.2,
        "heapTotal": 120.5,
        "percentage": 41.7
      }
    },
    "faultTolerance": {
      "messageQueue": {
        "queueLength": 15,
        "processing": 3,
        "successRate": 98.5
      }
    }
  }
}
```

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®

ç³»ç»Ÿæ”¯æŒä¸‰ç§ç¯å¢ƒé…ç½®ï¼š

1. **å¼€å‘ç¯å¢ƒ** (`development`)
   - è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
   - è¾ƒçŸ­çš„é‡è¯•é—´éš”
   - è¾ƒä½çš„èµ„æºé˜ˆå€¼

2. **ç”Ÿäº§ç¯å¢ƒ** (`production`)
   - ä¼˜åŒ–çš„æ€§èƒ½é…ç½®
   - å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦
   - è‡ªåŠ¨æ¢å¤æœºåˆ¶

3. **æµ‹è¯•ç¯å¢ƒ** (`test`)
   - æœ€å°åŒ–èµ„æºä½¿ç”¨
   - ç¦ç”¨è‡ªåŠ¨æ¢å¤
   - ç®€åŒ–æ—¥å¿—è®°å½•

### é…ç½®ç¤ºä¾‹

```typescript
// ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹
const productionConfig = {
  healthCheck: {
    enabled: true,
    interval: 60000, // 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    timeout: 10000,
    criticalThreshold: 2
  },
  processMonitor: {
    enabled: true,
    memoryThreshold: 512, // 512MB
    cpuThreshold: 75,
    maxUptime: 168, // 7å¤©
    enableAutoRestart: true
  },
  messageQueue: {
    enabled: true,
    maxConcurrent: 20,
    maxRetries: 5,
    initialDelay: 2000
  }
};
```

## ğŸ› ï¸ éƒ¨ç½²æŒ‡å—

### è‡ªåŠ¨éƒ¨ç½²

ä½¿ç”¨æä¾›çš„éƒ¨ç½²è„šæœ¬ï¼š

```bash
# 1. èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x deploy-fault-tolerance.sh

# 2. è¿è¡Œéƒ¨ç½²è„šæœ¬
./deploy-fault-tolerance.sh
```

### æ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. è¿›å…¥botç›®å½•
cd luckymart-tj/bot

# 2. å®‰è£…ä¾èµ–
npm install winston winston-daily-rotate-file

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
export TELEGRAM_BOT_TOKEN="your_bot_token"
export NODE_ENV="production"
export MINI_APP_URL="https://your-app.com"

# 4. å¯åŠ¨Bot
node start.ts
```

### PM2 éƒ¨ç½²

```bash
# 1. å®‰è£…PM2
npm install -g pm2

# 2. å¯åŠ¨Bot
pm2 start ecosystem.config.js

# 3. ç›‘æ§æ—¥å¿—
pm2 logs telegram-bot

# 4. é‡æ–°åŠ è½½é…ç½®
pm2 reload telegram-bot
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### Bot å‘½ä»¤å¢å¼º

åŸæœ‰çš„ Bot å‘½ä»¤å·²é›†æˆå®¹é”™æœºåˆ¶ï¼š

- `/start` - ç”¨æˆ·æ³¨å†Œï¼ŒåŒ…å«é”™è¯¯é‡è¯•å’Œæ—¥å¿—è®°å½•
- `/balance` - æŸ¥è¯¢ä½™é¢ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
- `/orders` - æŸ¥è¯¢è®¢å•ï¼Œæ”¯æŒå¤±è´¥é‡è¯•

### é”™è¯¯å¤„ç†

```typescript
// è‡ªåŠ¨é”™è¯¯è¿½è¸ª
try {
  await someOperation();
} catch (error) {
  // é”™è¯¯ä¼šè¢«è‡ªåŠ¨è®°å½•å’Œè¿½è¸ª
  errorTracker.recordError('operation_failed', error);
  
  // è§¦å‘æ¢å¤æœºåˆ¶
  await faultToleranceManager.triggerRecovery(
    'operation_failed', 
    'Database operation failed'
  );
}
```

### æ€§èƒ½ç›‘æ§

```typescript
// æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨æ”¶é›†
@performanceLogger('database_query')
async function queryDatabase() {
  // è‡ªåŠ¨è®°å½•æ‰§è¡Œæ—¶é—´
}

// ä¸šåŠ¡äº‹ä»¶è¿½è¸ª
logger.business('order_created', userId, {
  orderId: order.id,
  amount: order.total
});
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **Botæ— æ³•å¯åŠ¨**
   - æ£€æŸ¥ç¯å¢ƒå˜é‡ `TELEGRAM_BOT_TOKEN`
   - ç¡®è®¤ç«¯å£3001å¯ç”¨
   - æŸ¥çœ‹å¯åŠ¨æ—¥å¿—

2. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   - ç³»ç»Ÿä¼šè‡ªåŠ¨é‡å¯
   - æŸ¥çœ‹å†…å­˜ä½¿ç”¨æŒ‡æ ‡
   - æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼

3. **æ¶ˆæ¯å¤„ç†å¤±è´¥**
   - æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€
   - æ£€æŸ¥å¤±è´¥æ¶ˆæ¯æ—¥å¿—
   - æ‰‹åŠ¨é‡è¯•æœºåˆ¶

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f bot/logs/telegram-bot-*.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f bot/logs/telegram-bot-error-*.log

# PM2æ—¥å¿—
pm2 logs telegram-bot
```

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
curl http://localhost:3001/api/health

# æŸ¥çœ‹ç³»ç»ŸæŒ‡æ ‡
curl http://localhost:3001/api/metrics

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
curl http://localhost:3001/api/connections
```

## ğŸš¦ å‘Šè­¦å’Œé€šçŸ¥

### å‘Šè­¦è§¦å‘æ¡ä»¶

- å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼ (85%)
- CPUä½¿ç”¨æŒç»­è¶…è¿‡80%
- æ•°æ®åº“è¿æ¥å¤±è´¥
- è¿ç»­é”™è¯¯è¶…è¿‡é™åˆ¶

### å‘Šè­¦æ–¹å¼

1. **æ—¥å¿—è®°å½•** - æ‰€æœ‰å‘Šè­¦éƒ½ä¼šè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶
2. **ç›‘æ§ç«¯ç‚¹** - é€šè¿‡HTTP APIè®¿é—®å‘Šè­¦çŠ¶æ€
3. **Webhooké€šçŸ¥** - é…ç½®`MONITORING_WEBHOOK`æ¥æ”¶å®æ—¶é€šçŸ¥

## ğŸ” å®‰å…¨è€ƒè™‘

### è®¿é—®æ§åˆ¶

- ç›‘æ§ç«¯ç‚¹éœ€è¦è®¤è¯ (é…ç½® `RESTART_TOKEN`)
- ç¯å¢ƒå˜é‡å®‰å…¨ç®¡ç†
- æ—¥å¿—æ–‡ä»¶æƒé™æ§åˆ¶

### æ•°æ®ä¿æŠ¤

- æ•æ„Ÿä¿¡æ¯æ—¥å¿—è„±æ•
- ç”¨æˆ·æ•°æ®åŠ å¯†å­˜å‚¨
- APIè®¿é—®é¢‘ç‡é™åˆ¶

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### èµ„æºä½¿ç”¨

- å†…å­˜ä½¿ç”¨è‡ªåŠ¨ç›‘æ§å’Œé™åˆ¶
- CPUä½¿ç”¨ç‡å®æ—¶è·Ÿè¸ª
- ç£ç›˜ç©ºé—´è‡ªåŠ¨æ¸…ç†

### å“åº”æ—¶é—´

- æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
- æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- ç¼“å­˜æœºåˆ¶é›†æˆ

## ğŸ”„ æ›´æ–°å’Œç»´æŠ¤

### çƒ­æ›´æ–°æ”¯æŒ

- é…ç½®æ–‡ä»¶çƒ­é‡è½½
- åŠ¨æ€é˜ˆå€¼è°ƒæ•´
- åœ¨çº¿é‡å¯æœºåˆ¶

### å®šæœŸç»´æŠ¤

- æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨æ¸…ç†
- æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- ç¼“å­˜å®šæœŸæ¸…ç†

## ğŸ¤ è´¡çŒ®æŒ‡å—

### ä»£ç è§„èŒƒ

- ä½¿ç”¨TypeScriptè¿›è¡Œç±»å‹å®‰å…¨
- éµå¾ªç°æœ‰çš„é”™è¯¯å¤„ç†æ¨¡å¼
- æ·»åŠ é€‚å½“çš„æ—¥å¿—è®°å½•
- ç¼–å†™å•å…ƒæµ‹è¯•

### æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
npm test

# è¿è¡Œé›†æˆæµ‹è¯•
npm run test:integration

# æ€§èƒ½æµ‹è¯•
npm run test:performance
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—å’Œç›‘æ§æŒ‡æ ‡
3. é€šè¿‡GitHub Issuesæäº¤é—®é¢˜
4. è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒ

---

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¶é—´**: 2024-01-15  
**ç»´æŠ¤è€…**: LuckyMart TJ å¼€å‘å›¢é˜Ÿ