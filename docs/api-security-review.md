# LuckyMart-TJ API å®‰å…¨å®¡æŸ¥æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æŠ¥å‘Šå¯¹ LuckyMart-TJ é¡¹ç›®çš„æ‰€æœ‰ API ç«¯ç‚¹è¿›è¡Œäº†å®‰å…¨å®¡æŸ¥ï¼Œæ£€æŸ¥äº† 32 ä¸ª API ç«¯ç‚¹çš„å®‰å…¨æ€§ã€‚å®¡æŸ¥å‘ç°å¤šä¸ªä¸¥é‡å’Œä¸€èˆ¬çº§åˆ«çš„å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ç«‹å³ä¿®å¤ä»¥ç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚

## å®¡æŸ¥èŒƒå›´

- **å®¡æŸ¥æ–‡ä»¶æ•°é‡**: 32 ä¸ª API ç«¯ç‚¹
- **å®¡æŸ¥é¡¹ç›®**:
  1. é”™è¯¯å¤„ç†å’ŒHTTPçŠ¶æ€ç 
  2. å‚æ•°éªŒè¯å®Œå–„æ€§
  3. æ•°æ®åº“æŸ¥è¯¢å®‰å…¨æ€§
  4. SQLæ³¨å…¥é£é™©
  5. æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©

## ä¸¥é‡å®‰å…¨é£é™© (Critical)

### 1. ç®¡ç†å‘˜åˆå§‹åŒ–ç«¯ç‚¹æ— æƒé™æ§åˆ¶
**æ–‡ä»¶**: `/api/admin/init/route.ts`

**é—®é¢˜æè¿°**:
- ç«¯ç‚¹æ²¡æœ‰ä»»ä½•æƒé™æ§åˆ¶ï¼Œä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨
- åˆ›å»ºç¡¬ç¼–ç å¯†ç çš„ç®¡ç†å‘˜è´¦å· (admin/admin123456)
- è¿”å›é»˜è®¤å¯†ç ä¿¡æ¯

**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡

**ä¿®å¤å»ºè®®**:
```typescript
// æ·»åŠ IPç™½åå•æˆ–ç®¡ç†å‘˜éªŒè¯
export async function POST(request: Request) {
  // æ£€æŸ¥è¯·æ±‚æ¥æºIP
  const clientIP = request.headers.get('x-forwarded-for') || 
                   request.headers.get('x-real-ip') || 
                   'unknown';
  
  // åªå…è®¸ç‰¹å®šIPæˆ–localhostè®¿é—®
  const allowedIPs = process.env.ALLOWED_INIT_IPS?.split(',') || ['127.0.0.1'];
  if (!allowedIPs.includes(clientIP)) {
    return NextResponse.json({ error: 'æ— æƒè®¿é—®' }, { status: 403 });
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç®¡ç†å‘˜
  // ...
}
```

### 2. ç®¡ç†å‘˜APIæƒé™éªŒè¯ä¸å®Œå–„
**æ–‡ä»¶**: å¤šä¸ªç®¡ç†å‘˜ç«¯ç‚¹ (å¦‚ `/api/admin/products/[id]/route.ts`)

**é—®é¢˜æè¿°**:
- å¤§å¤šæ•°ç®¡ç†å‘˜APIåªæ£€æŸ¥tokenå­˜åœ¨
- æ²¡æœ‰éªŒè¯JWTæœ‰æ•ˆæ€§
- æ²¡æœ‰éªŒè¯ç®¡ç†å‘˜æƒé™

**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡

**ä¿®å¤å»ºè®®**:
```typescript
// åˆ›å»ºç»Ÿä¸€çš„æƒé™ä¸­é—´ä»¶
import { verifyAdminToken } from '@/lib/auth';

export async function GET(request: NextRequest) {
  const user = verifyAdminToken(request);
  if (!user) {
    return NextResponse.json({ error: 'æƒé™ä¸è¶³' }, { status: 403 });
  }
  // ...
}
```

## ä¸€èˆ¬å®‰å…¨é£é™© (High)

### 3. é”™è¯¯ä¿¡æ¯æ³„éœ²
**å½±å“ç«¯ç‚¹**: å‡ ä¹æ‰€æœ‰APIç«¯ç‚¹

**é—®é¢˜æè¿°**:
- é”™è¯¯å“åº”ä¸­æš´éœ² `error.message`ï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
- åŒ…å«æ•°æ®åº“é”™è¯¯ã€å†…éƒ¨å®ç°ç»†èŠ‚

**ç¤ºä¾‹é—®é¢˜ä»£ç **:
```typescript
// å±é™©çš„é”™è¯¯å¤„ç†
return NextResponse.json(
  { error: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', message: error.message },
  { status: 500 }
);
```

**ä¿®å¤å»ºè®®**:
```typescript
// å®‰å…¨çš„é”™è¯¯å¤„ç†
catch (error: any) {
  console.error('Get profile error:', error);
  return NextResponse.json(
    { error: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' },
    { status: 500 }
  );
}
```

### 4. æ”¯ä»˜ä¿¡æ¯æš´éœ²
**æ–‡ä»¶**: `/api/payment/recharge/route.ts`

**é—®é¢˜æè¿°**:
- å“åº”ä¸­åŒ…å«ç¯å¢ƒå˜é‡ä¸­çš„æ”¯ä»˜è´¦æˆ·ä¿¡æ¯
- å¯èƒ½æ³„éœ²æ•æ„Ÿçš„æ”¯ä»˜è´¦æˆ·è¯¦æƒ…

**ä¿®å¤å»ºè®®**:
```typescript
// ä¸è¦åœ¨å“åº”ä¸­æš´éœ²å®Œæ•´çš„æ”¯ä»˜ä¿¡æ¯
const paymentInstructions = {
  method: paymentMethod,
  reference: orderNumber,
  expiresAt: new Date(Date.now() + 15 * 60 * 1000).toISOString()
  // ç§»é™¤æ•æ„Ÿçš„è´¦æˆ·ä¿¡æ¯
};
```

### 5. ç³»ç»Ÿè®¾ç½®å­˜å‚¨é£é™©
**æ–‡ä»¶**: `/api/admin/settings/route.ts`

**é—®é¢˜æè¿°**:
- ä½¿ç”¨å†…å­˜å­˜å‚¨æ•æ„Ÿè®¾ç½®ä¿¡æ¯
- æœåŠ¡å™¨é‡å¯ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
- é“¶è¡Œè´¦æˆ·ä¿¡æ¯ç›´æ¥å­˜å‚¨åœ¨å†…å­˜ä¸­

**ä¿®å¤å»ºè®®**:
- ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ç³»ç»Ÿè®¾ç½®
- å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡ŒåŠ å¯†å­˜å‚¨

## ä¸­ç­‰é£é™© (Medium)

### 6. å‚æ•°éªŒè¯ä¸ä¸¥æ ¼
**é—®é¢˜æè¿°**:
- éƒ¨åˆ†ç«¯ç‚¹ç¼ºå°‘å¯¹IDå‚æ•°æ ¼å¼çš„éªŒè¯
- æ•°å­—ç±»å‹å‚æ•°ç¼ºå°‘èŒƒå›´æ£€æŸ¥

**ä¿®å¤å»ºè®®**:
```typescript
// æ·»åŠ å‚æ•°éªŒè¯
const id = params.id;
if (!id || typeof id !== 'string' || id.length < 10) {
  return NextResponse.json({ error: 'æ— æ•ˆçš„IDæ ¼å¼' }, { status: 400 });
}
```

### 7. äº‹åŠ¡å¤„ç†ä¸ä¸€è‡´
**é—®é¢˜æè¿°**:
- æœ‰äº›åœ°æ–¹ä½¿ç”¨Prisma `$transaction`
- æœ‰äº›ä½¿ç”¨Supabaseä½†æ²¡æœ‰äº‹åŠ¡ä¿æŠ¤
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**ä¿®å¤å»ºè®®**:
- ç»Ÿä¸€ä½¿ç”¨äº‹åŠ¡å¤„ç†å…³é”®æ“ä½œ
- å¯¹äºæ¶‰åŠå¤šä¸ªè¡¨ä¿®æ”¹çš„æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨äº‹åŠ¡

### 8. èº«ä»½éªŒè¯å®ç°ä¸ä¸€è‡´
**é—®é¢˜æè¿°**:
- æœ‰äº›ä½¿ç”¨ `jwt.verify()`
- æœ‰äº›ä½¿ç”¨ `getUserFromRequest()`
- éªŒè¯é€»è¾‘ä¸ç»Ÿä¸€

**ä¿®å¤å»ºè®®**:
- åˆ›å»ºç»Ÿä¸€çš„èº«ä»½éªŒè¯ä¸­é—´ä»¶
- ç»Ÿä¸€JWTéªŒè¯å’Œè§£æé€»è¾‘

## ä½é£é™© (Low)

### 9. ç¼ºå°‘é€Ÿç‡é™åˆ¶
**é—®é¢˜æè¿°**:
- æ²¡æœ‰å¯¹APIè°ƒç”¨è¿›è¡Œé€Ÿç‡é™åˆ¶
- å¯èƒ½é­å—æš´åŠ›æ”»å‡»

**ä¿®å¤å»ºè®®**:
- å®æ–½APIé€Ÿç‡é™åˆ¶
- å¯¹æ•æ„Ÿæ“ä½œæ·»åŠ é¢å¤–ä¿æŠ¤

### 10. ç¼ºå°‘è¾“å…¥æ¸…æ´—
**é—®é¢˜æè¿°**:
- ç”¨æˆ·è¾“å…¥æ²¡æœ‰è¢«å……åˆ†æ¸…æ´—
- å¯èƒ½å¯¼è‡´XSSæˆ–å…¶ä»–æ³¨å…¥æ”»å‡»

**ä¿®å¤å»ºè®®**:
- å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒHTMLç¼–ç 
- ä½¿ç”¨ç™½åå•éªŒè¯è¾“å…¥å€¼

## å®‰å…¨æœ€ä½³å®è·µå»ºè®®

### 1. å®æ–½ç»Ÿä¸€é”™è¯¯å¤„ç†
```typescript
// åˆ›å»ºç»Ÿä¸€çš„APIå“åº”æ ¼å¼
export function createErrorResponse(message: string, status: number = 500) {
  return NextResponse.json(
    { success: false, error: message },
    { status }
  );
}
```

### 2. æ·»åŠ è¯·æ±‚éªŒè¯ä¸­é—´ä»¶
```typescript
// ä½¿ç”¨Zodæˆ–ç±»ä¼¼åº“éªŒè¯è¯·æ±‚æ•°æ®
import { z } from 'zod';

const RechargeSchema = z.object({
  packageId: z.string().uuid(),
  paymentMethod: z.enum(['alif_mobi', 'dc_bank', 'mock'])
});

export async function POST(request: NextRequest) {
  const body = await request.json();
  const validated = RechargeSchema.parse(body);
  // ...
}
```

### 3. å®æ–½æƒé™æ§åˆ¶
```typescript
// åˆ›å»ºæƒé™è£…é¥°å™¨æˆ–ä¸­é—´ä»¶
export function requireAdmin(handler: Handler) {
  return async (req: NextRequest, params: any) => {
    const user = await verifyAdminToken(req);
    if (!user) {
      return NextResponse.json({ error: 'æƒé™ä¸è¶³' }, { status: 403 });
    }
    return handler(req, params);
  };
}
```

### 4. æ·»åŠ æ—¥å¿—å’Œç›‘æ§
```typescript
// æ·»åŠ å®‰å…¨äº‹ä»¶æ—¥å¿—
import { logSecurityEvent } from '@/lib/security';

export async function POST(request: NextRequest) {
  try {
    // å¤„ç†è¯·æ±‚
  } catch (error) {
    await logSecurityEvent({
      type: 'api_error',
      endpoint: '/payment/recharge',
      error: error.message,
      timestamp: new Date()
    });
    // è¿”å›å®‰å…¨é”™è¯¯ä¿¡æ¯
  }
}
```

## ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”¥ ç«‹å³ä¿®å¤ (1-2å¤©)
1. ç®¡ç†å‘˜åˆå§‹åŒ–ç«¯ç‚¹æƒé™æ§åˆ¶
2. ç®¡ç†å‘˜APIæƒé™éªŒè¯
3. é”™è¯¯ä¿¡æ¯æ³„éœ²é—®é¢˜

### âš¡ ä¼˜å…ˆä¿®å¤ (1å‘¨å†…)
4. æ”¯ä»˜ä¿¡æ¯æš´éœ²
5. ç³»ç»Ÿè®¾ç½®å­˜å‚¨å®‰å…¨
6. ç»Ÿä¸€äº‹åŠ¡å¤„ç†

### ğŸ“‹ è®¡åˆ’ä¿®å¤ (1ä¸ªæœˆå†…)
7. å‚æ•°éªŒè¯å®Œå–„
8. èº«ä»½éªŒè¯ç»Ÿä¸€
9. å®æ–½é€Ÿç‡é™åˆ¶
10. æ·»åŠ ç›‘æ§æ—¥å¿—

## æ€»ç»“

LuckyMart-TJé¡¹ç›®çš„APIå­˜åœ¨å¤šä¸ªå®‰å…¨é—®é¢˜ï¼Œä¸»è¦é›†ä¸­åœ¨æƒé™æ§åˆ¶ã€é”™è¯¯å¤„ç†å’Œæ•°æ®ä¿æŠ¤æ–¹é¢ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥ä¿®å¤è¿™äº›é—®é¢˜ï¼Œç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚

## å®¡æŸ¥è€…ä¿¡æ¯
- **å®¡æŸ¥æ—¥æœŸ**: 2025-10-30
- **å®¡æŸ¥èŒƒå›´**: 32ä¸ªAPIç«¯ç‚¹
- **å‘ç°é—®é¢˜**: 10ä¸ªä¸»è¦å®‰å…¨é—®é¢˜
- **é£é™©ç­‰çº§**: 3ä¸ªä¸¥é‡ï¼Œ4ä¸ªä¸­ç­‰ï¼Œ3ä¸ªä½é£é™©
