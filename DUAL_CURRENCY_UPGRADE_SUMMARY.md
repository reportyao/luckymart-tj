# åŒè´§å¸æ•°æ®åº“å‡çº§å®Œæˆæ€»ç»“

## âœ… å‡çº§å®ŒæˆçŠ¶æ€

**å‡çº§æ—¶é—´**: 2025-10-31 15:58:11  
**å‡çº§ç‰ˆæœ¬**: v2.0.0  
**å…¼å®¹æ€§**: âœ… å®Œå…¨å‘åå…¼å®¹  

## ğŸ“‹ å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ•°æ®åº“ç»“æ„æ›´æ–° (schema.prisma)
- âœ… åœ¨ `users` è¡¨ä¸­æ·»åŠ  `luckyCoins` å­—æ®µ (Decimal, é»˜è®¤ 0)
- âœ… åœ¨ `users` è¡¨ä¸­æ·»åŠ  `luckyCoinsVersion` å­—æ®µ (Int, é»˜è®¤ 1)  
- âœ… ä¸ºæ–°å­—æ®µæ·»åŠ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

### 2. æ•°æ®åº“è¿ç§»æ–‡ä»¶
- âœ… åˆ›å»ºè¿ç§»æ–‡ä»¶: `prisma/migrations/20251031_add_lucky_coins/migration.sql`
- âœ… åŒ…å«å®Œæ•´çš„ SQL è¿ç§»è¯­å¥
- âœ… åŒ…å«ç´¢å¼•ä¼˜åŒ–å’Œæ³¨é‡Š

### 3. æ–‡æ¡£å’Œè„šæœ¬
- âœ… åˆ›å»ºè¯¦ç»†çš„å‡çº§è¯´æ˜æ–‡æ¡£: `docs/database-upgrade-dual-currency.md`
- âœ… åˆ›å»ºè‡ªåŠ¨æ‰§è¡Œè„šæœ¬: `scripts/upgrade-dual-currency.sh`

## ğŸ”‘ æ ¸å¿ƒç‰¹æ€§

### åŒè´§å¸ä½“ç³»
- **Som è´§å¸**: åŸæœ‰åŸºç¡€è´§å¸ (balance å­—æ®µ)
- **Lucky Coins**: æ–°å¢å¹¸è¿å¸ (luckyCoins å­—æ®µ)
- **å›ºå®šæ±‡ç‡**: 1 å¹¸è¿å¸ = 1 Som

### æŠ€æœ¯ç‰¹æ€§  
- **ç‰ˆæœ¬æ§åˆ¶**: ä¹è§‚é”æœºåˆ¶é˜²æ­¢å¹¶å‘å†²çª
- **æ€§èƒ½ä¼˜åŒ–**: ä¸“ç”¨ç´¢å¼•æå‡æŸ¥è¯¢æ•ˆç‡
- **å‘åå…¼å®¹**: ç°æœ‰æ•°æ®å’ŒåŠŸèƒ½å®Œå…¨ä¸å—å½±å“

## ğŸš€ æ‰§è¡Œå‡çº§

### è‡ªåŠ¨åŒ–æ–¹å¼ (æ¨è)
```bash
cd /workspace/luckymart-tj
chmod +x scripts/upgrade-dual-currency.sh
./scripts/upgrade-dual-currency.sh
```

### æ‰‹åŠ¨æ–¹å¼
```bash
cd /workspace/luckymart-tj

# 1. åº”ç”¨è¿ç§»
npx prisma migrate deploy

# 2. ç”Ÿæˆå®¢æˆ·ç«¯
npx prisma generate

# 3. éªŒè¯å‡çº§
# æ£€æŸ¥æ–°å­—æ®µæ˜¯å¦å­˜åœ¨
```

## ğŸ’¡ ä¸šåŠ¡åº”ç”¨ç¤ºä¾‹

### å¹¸è¿å¸å……å€¼
```typescript
// 1 Som å……å€¼ 1 å¹¸è¿å¸
await prisma.users.update({
  where: { id: userId },
  data: {
    balance: { decrement: amount },
    luckyCoins: { increment: amount },
    balanceVersion: { increment: 1 },
    luckyCoinsVersion: { increment: 1 }
  }
});
```

### æŠ½å¥–ä½¿ç”¨
```typescript
// ä½¿ç”¨å¹¸è¿å¸å‚ä¸æŠ½å¥–
await prisma.participations.create({
  data: {
    userId,
    roundId, 
    sharesCount: shares,
    type: 'lucky_coins',
    cost: shares  // 1 ä»½é¢ = 1 å¹¸è¿å¸
  }
});
```

## ğŸ“Š å½±å“èŒƒå›´

| é¡¹ç›® | å½±å“ | è¯´æ˜ |
|------|------|------|
| ç°æœ‰åŠŸèƒ½ | âœ… æ— å½±å“ | æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ |
| ç°æœ‰æ•°æ® | âœ… æ— å½±å“ | æ•°æ®åº“ç»“æ„å‘åå…¼å®¹ |
| API æ¥å£ | ğŸ”„ å¯é€‰ | å¯é€‰æ‹©æ€§åœ°æ·»åŠ å¹¸è¿å¸ç›¸å…³æ¥å£ |
| ä¸šåŠ¡é€»è¾‘ | ğŸ”„ å¯é€‰ | å¯é€‰æ‹©æ€§åœ°é›†æˆå¹¸è¿å¸åŠŸèƒ½ |

## ğŸ” éªŒè¯æ¸…å•

å‡çº§å®Œæˆåï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] æ–°å­—æ®µ `lucky_coins` å’Œ `lucky_coins_version` å­˜åœ¨
- [ ] ç´¢å¼• `users_lucky_coins_idx` ç­‰å·²åˆ›å»º
- [ ] Prisma å®¢æˆ·ç«¯å·²æ›´æ–°
- [ ] ç°æœ‰ç”¨æˆ·åŠŸèƒ½æ­£å¸¸
- [ ] æ–°å¢å¹¸è¿å¸åŠŸèƒ½æµ‹è¯•é€šè¿‡

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- è¯¦ç»†æ–‡æ¡£: `docs/database-upgrade-dual-currency.md`
- è¿ç§»æ–‡ä»¶: `prisma/migrations/20251031_add_lucky_coins/migration.sql`
- æ‰§è¡Œè„šæœ¬: `scripts/upgrade-dual-currency.sh`

---
**å‡çº§çŠ¶æ€**: ğŸ‰ **å®Œæˆ** | **å»ºè®®**: ç«‹å³åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åŠŸèƒ½