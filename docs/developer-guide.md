# å¼€å‘è€…æŒ‡å—

æœ¬æ–‡æ¡£ä¸ºLuckyMart-TJç³»ç»Ÿçš„å¼€å‘è€…æä¾›è¯¦ç»†çš„æŠ€æœ¯æ¶æ„ã€ä»£ç è§„èŒƒã€å¼€å‘ç¯å¢ƒå’Œæœ€ä½³å®è·µæŒ‡å¯¼ã€‚

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¦‚è§ˆ
LuckyMart-TJé‡‡ç”¨ç°ä»£åŒ–å…¨æ ˆæ¶æ„ï¼ŒåŸºäºNext.jsã€Supabaseå’ŒPrismaæ„å»ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js App   â”‚    â”‚  Telegram Bot   â”‚    â”‚  Admin Panel    â”‚
â”‚   (Frontend)    â”‚    â”‚   (Service)     â”‚    â”‚   (Frontend)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway (Next.js API Routes)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Business Logic Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Referral    â”‚ â”‚ Anti-Fraud  â”‚ â”‚ Instagram   â”‚ â”‚ QR Code     â”‚ â”‚
â”‚  â”‚ System      â”‚ â”‚ System      â”‚ â”‚ Poster API  â”‚ â”‚ Generator   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Access Layer                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚   Prisma ORM    â”‚ â”‚   Cache Layer   â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Database & Storage                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PostgreSQL  â”‚ â”‚   Redis     â”‚ â”‚ Supabase    â”‚ â”‚ File        â”‚ â”‚
â”‚  â”‚ (Primary)   â”‚ â”‚ (Cache)     â”‚ â”‚ (Auth/API)  â”‚ â”‚ Storage     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### å‰ç«¯ (Next.js)
- **æ¡†æ¶**: Next.js 14.2.33
- **è¯­è¨€**: TypeScript 5.6.2
- **UIåº“**: React 18.3.1 + Tailwind CSS 3.4.10
- **çŠ¶æ€ç®¡ç†**: React Context + Hooks
- **è·¯ç”±**: Next.js App Router

#### åç«¯æœåŠ¡
- **APIå±‚**: Next.js API Routes
- **ORM**: Prisma 6.18.0
- **è®¤è¯**: Supabase Auth + JWT
- **ç¼“å­˜**: Redis (ioredis 5.4.1)
- **é˜Ÿåˆ—**: Supabase Edge Functions

#### æ•°æ®åº“
- **ä¸»æ•°æ®åº“**: PostgreSQL 13+
- **ç¼“å­˜**: Redis 6.0+
- **å­˜å‚¨**: Supabase Storage
- **æœç´¢**: PostgreSQL Full-text Search

#### å¤–éƒ¨æœåŠ¡
- **è®¤è¯æœåŠ¡**: Supabase Auth
- **æœºå™¨äºº**: Telegram Bot API
- **æ”¯ä»˜**: é›†æˆå¤šç§æ”¯ä»˜ç½‘å…³
- **ç›‘æ§**: è‡ªå»ºç›‘æ§ç³»ç»Ÿ

## ğŸ“ é¡¹ç›®ç»“æ„

```
luckymart-tj/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/                   # è®¤è¯ç›¸å…³é¡µé¢
â”‚   â”œâ”€â”€ api/                      # API Routes
â”‚   â”‚   â”œâ”€â”€ auth/                 # è®¤è¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ user/                 # ç”¨æˆ·ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ products/             # äº§å“ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ orders/               # è®¢å•å¤„ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ referral/             # æ¨èç³»ç»Ÿæ¥å£
â”‚   â”‚   â”œâ”€â”€ rewards/              # å¥–åŠ±ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ bot/                  # æœºå™¨äººç›¸å…³æ¥å£
â”‚   â”‚   â”œâ”€â”€ anti-fraud/           # é˜²æ¬ºè¯ˆç³»ç»Ÿæ¥å£
â”‚   â”‚   â”œâ”€â”€ instagram/            # Instagram APIæ¥å£
â”‚   â”‚   â””â”€â”€ qr/                   # QRç ç”Ÿæˆæ¥å£
â”‚   â”œâ”€â”€ admin/                    # ç®¡ç†åå°
â”‚   â”œâ”€â”€ referral/                 # æ¨èç³»ç»Ÿé¡µé¢
â”‚   â”œâ”€â”€ profile/                  # ç”¨æˆ·ä¸ªäººä¸­å¿ƒ
â”‚   â”œâ”€â”€ products/                 # äº§å“é¡µé¢
â”‚   â””â”€â”€ ...
â”œâ”€â”€ bot/                          # Telegramæœºå™¨äºº
â”‚   â”œâ”€â”€ index.ts                  # æœºå™¨äººå…¥å£
â”‚   â”œâ”€â”€ handlers/                 # æ¶ˆæ¯å¤„ç†å™¨
â”‚   â”œâ”€â”€ services/                 # ä¸šåŠ¡æœåŠ¡
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”œâ”€â”€ lib/                          # æ ¸å¿ƒåº“
â”‚   â”œâ”€â”€ auth.ts                   # è®¤è¯ç›¸å…³
â”‚   â”œâ”€â”€ prisma.ts                 # æ•°æ®åº“å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ cache-manager.ts          # ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ database-lock.ts          # æ•°æ®åº“é”
â”‚   â”œâ”€â”€ anti-fraud/               # é˜²æ¬ºè¯ˆç³»ç»Ÿ
â”‚   â”œâ”€â”€ instagram-poster/         # Instagramæµ·æŠ¥ç”Ÿæˆ
â”‚   â”œâ”€â”€ qr-code/                  # QRç ç”Ÿæˆ
â”‚   â””â”€â”€ types/                    # TypeScriptç±»å‹å®šä¹‰
â”œâ”€â”€ prisma/                       # æ•°æ®åº“æ¶æ„
â”‚   â”œâ”€â”€ schema.prisma             # Prismaæ¨¡å¼
â”‚   â””â”€â”€ migrations/               # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â”œâ”€â”€ docs/                         # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ __tests__/                    # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ components/                   # Reactç»„ä»¶
â”œâ”€â”€ hooks/                        # è‡ªå®šä¹‰Hook
â”œâ”€â”€ public/                       # é™æ€èµ„æº
â””â”€â”€ scripts/                      # æ„å»ºå’Œéƒ¨ç½²è„šæœ¬
```

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒè®¾ç½®

### ç¯å¢ƒè¦æ±‚
```bash
Node.js >= 20.14.15
npm >= 9.0.0
PostgreSQL >= 13
Redis >= 6.0
Docker (å¯é€‰)
```

### æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd luckymart-tj
```

2. **å®‰è£…ä¾èµ–**
```bash
npm install
```

3. **ç¯å¢ƒé…ç½®**
```bash
cp .env.example .env.local
```

ç¼–è¾‘ `.env.local`:
```env
# æ•°æ®åº“
DATABASE_URL="postgresql://username:password@localhost:5432/luckymart"

# Supabase
NEXT_PUBLIC_SUPABASE_URL="your-supabase-url"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-supabase-anon-key"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"

# Redis
REDIS_URL="redis://localhost:6379"

# JWT
JWT_SECRET="your-super-secret-jwt-key"
JWT_REFRESH_SECRET="your-refresh-secret-key"

# Telegram Bot
TELEGRAM_BOT_TOKEN="your-bot-token"
TELEGRAM_WEBHOOK_URL="https://your-domain.com/api/bot/webhook"

# Instagram API
INSTAGRAM_CLIENT_ID="your-instagram-client-id"
INSTAGRAM_CLIENT_SECRET="your-instagram-client-secret"

# å…¶ä»–é…ç½®
NODE_ENV="development"
LOG_LEVEL="debug"
```

4. **æ•°æ®åº“è®¾ç½®**
```bash
# ç”ŸæˆPrismaå®¢æˆ·ç«¯
npm run prisma:generate

# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run prisma:migrate

# å¡«å……åˆå§‹æ•°æ®
npm run db:seed
```

5. **å¯åŠ¨å¼€å‘æœåŠ¡**
```bash
# å¯åŠ¨Next.jså¼€å‘æœåŠ¡å™¨
npm run dev

# å¯åŠ¨Redis (å¦‚æœä½¿ç”¨Docker)
docker run -d -p 6379:6379 redis:6-alpine

# å¯åŠ¨æœºå™¨äººæœåŠ¡ (æ–°ç»ˆç«¯)
npm run bot:dev
```

### å¼€å‘å·¥å…·é…ç½®

#### VS Codeé…ç½®
åˆ›å»º `.vscode/settings.json`:
```json
{
  "typescript.preferences.importModuleSpecifier": "relative",
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.css": "tailwindcss"
  },
  "tailwindCSS.experimental.classRegex": [
    ["cva\\(([^)]*)\\)", "[\"'`]([^\"'`]*).*?[\"'`]"],
    ["cx\\(([^)]*)\\)", "(?:'|\"|`)([^']*)(?:'|\"|`)"]
  ]
}
```

#### æ¨èçš„VS Codeæ’ä»¶
- ES7+ React/Redux/React-Native snippets
- Tailwind CSS IntelliSense
- TypeScript Importer
- Prettier - Code formatter
- ESLint
- Auto Rename Tag
- Bracket Pair Colorizer
- GitLens
- Thunder Client (APIæµ‹è¯•)

## ğŸ“ ä»£ç è§„èŒƒ

### TypeScriptè§„èŒƒ

#### ç±»å‹å®šä¹‰
```typescript
// lib/types/index.ts
export interface User {
  id: string;
  email: string;
  name: string;
  phone?: string;
  coinBalance: number;
  referralCode: string;
  createdAt: Date;
  updatedAt: Date;
}

export interface ReferralRelationship {
  id: string;
  referrerId: string;
  refereeId: string;
  level: number;
  createdAt: Date;
}

export interface RewardTransaction {
  id: string;
  userId: string;
  amount: number;
  type: 'referral' | 'bonus' | 'withdrawal';
  status: 'pending' | 'completed' | 'failed';
  metadata?: Record<string, any>;
  createdAt: Date;
}
```

#### æ¥å£å‘½åè§„èŒƒ
```typescript
// ä½¿ç”¨PascalCaseå‘½åæ¥å£
interface UserProfile { ... }
interface ApiResponse<T> { ... }

// ä½¿ç”¨Iå‰ç¼€ï¼ˆå¯é€‰ï¼‰
interface IUser { ... }
```

### Reactç»„ä»¶è§„èŒƒ

#### ç»„ä»¶ç»“æ„
```tsx
// components/UserProfile.tsx
'use client';

import React from 'react';
import { User } from '@/lib/types';

interface UserProfileProps {
  user: User;
  onUpdate?: (user: Partial<User>) => void;
}

export const UserProfile: React.FC<UserProfileProps> = ({
  user,
  onUpdate
}) => {
  return (
    <div className="user-profile">
      <h2 className="text-2xl font-bold">{user.name}</h2>
      <p className="text-gray-600">{user.email}</p>
    </div>
  );
};

// å¯¼å‡ºé»˜è®¤ç»„ä»¶
export default UserProfile;
```

#### Hookä½¿ç”¨
```tsx
// hooks/useUserData.ts
'use client';

import { useState, useEffect } from 'react';
import { User } from '@/lib/types';
import { apiClient } from '@/lib/api-client';

export const useUserData = (userId: string) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchUser = async () => {
      try {
        setLoading(true);
        const userData = await apiClient.getUser(userId);
        setUser(userData);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error');
      } finally {
        setLoading(false);
      }
    };

    if (userId) {
      fetchUser();
    }
  }, [userId]);

  return { user, loading, error };
};
```

### APIè·¯ç”±è§„èŒƒ

#### è·¯ç”±ç»“æ„
```typescript
// app/api/user/profile/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { prisma } from '@/lib/prisma';
import { UserProfileSchema } from '@/lib/validators';

export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    
    if (!session?.user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      select: {
        id: true,
        email: true,
        name: true,
        phone: true,
        coinBalance: true,
        referralCode: true,
        createdAt: true,
        updatedAt: true
      }
    });

    if (!user) {
      return NextResponse.json(
        { error: 'User not found' },
        { status: 404 }
      );
    }

    return NextResponse.json({ success: true, data: user });
  } catch (error) {
    console.error('Profile fetch error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}

export async function PUT(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    
    if (!session?.user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validatedData = UserProfileSchema.parse(body);

    const updatedUser = await prisma.user.update({
      where: { id: session.user.id },
      data: validatedData,
      select: {
        id: true,
        email: true,
        name: true,
        phone: true,
        coinBalance: true,
        referralCode: true,
        createdAt: true,
        updatedAt: true
      }
    });

    return NextResponse.json({ success: true, data: updatedUser });
  } catch (error) {
    console.error('Profile update error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### æ•°æ®åº“è§„èŒƒ

#### Prisma Schema
```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  name            String?
  phone           String?
  password        String
  coinBalance     Decimal  @default(0) @db.Decimal(10, 2)
  referralCode    String   @unique
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³ç³»å®šä¹‰
  referralRelationships ReferralRelationship[] @relation("UserReferrals")
  referredUsers         ReferralRelationship[] @relation("UserReferrals")
  rewardTransactions    RewardTransaction[]
  
  @@map("users")
}

model ReferralRelationship {
  id         String @id @default(uuid())
  referrerId String
  refereeId  String
  level      Int

  referrer User @relation("UserReferrals", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  User @relation("UserReferrals", fields: [refereeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([referrerId, refereeId])
  @@map("referral_relationships")
}
```

#### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```typescript
// lib/queries/user-queries.ts
export class UserQueryService {
  // ä½¿ç”¨selectä¼˜åŒ–æŸ¥è¯¢å­—æ®µ
  static async getUserWithReferrals(userId: string) {
    return prisma.user.findUnique({
      where: { id: userId },
      select: {
        id: true,
        email: true,
        name: true,
        coinBalance: true,
        referralCode: true,
        referralRelationships: {
          select: {
            id: true,
            level: true,
            createdAt: true,
            referee: {
              select: {
                id: true,
                name: true,
                email: true,
                createdAt: true
              }
            }
          }
        }
      }
    });
  }

  // æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
  static async getUsersByIds(userIds: string[]) {
    return prisma.user.findMany({
      where: {
        id: { in: userIds }
      },
      select: {
        id: true,
        name: true,
        email: true
      }
    });
  }

  // åˆ†é¡µæŸ¥è¯¢
  static async getPaginatedUsers(page: number, limit: number) {
    const skip = (page - 1) * limit;
    
    const [users, total] = await Promise.all([
      prisma.user.findMany({
        skip,
        take: limit,
        select: {
          id: true,
          name: true,
          email: true,
          createdAt: true
        },
        orderBy: {
          createdAt: 'desc'
        }
      }),
      prisma.user.count()
    ]);

    return {
      users,
      total,
      pages: Math.ceil(total / limit),
      currentPage: page
    };
  }
}
```

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### æµ‹è¯•ç»“æ„
```
__tests__/
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ components/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ database/
â”‚   â””â”€â”€ services/
â””â”€â”€ e2e/                    # ç«¯åˆ°ç«¯æµ‹è¯•
    â”œâ”€â”€ user-flows/
    â””â”€â”€ admin-flows/
```

### å•å…ƒæµ‹è¯•ç¤ºä¾‹
```typescript
// __tests__/lib/cache-manager.test.ts
import { CacheManager } from '@/lib/cache-manager';

describe('CacheManager', () => {
  let cacheManager: CacheManager;

  beforeEach(() => {
    cacheManager = new CacheManager();
  });

  afterEach(async () => {
    await cacheManager.clear();
  });

  describe('set', () => {
    it('should set a value in cache', async () => {
      await cacheManager.set('test-key', 'test-value', 3600);
      
      const value = await cacheManager.get('test-key');
      expect(value).toBe('test-value');
    });

    it('should handle TTL correctly', async () => {
      await cacheManager.set('test-key', 'test-value', 1);
      
      // Wait for expiration
      await new Promise(resolve => setTimeout(resolve, 1100));
      
      const value = await cacheManager.get('test-key');
      expect(value).toBeNull();
    });
  });

  describe('get', () => {
    it('should return null for non-existent keys', async () => {
      const value = await cacheManager.get('non-existent-key');
      expect(value).toBeNull();
    });
  });
});
```

### APIæµ‹è¯•ç¤ºä¾‹
```typescript
// __tests__/api/auth.test.ts
import { createMocks } from 'node-mocks-http';
import handler from '@/app/api/auth/login/route';

describe('/api/auth/login', () => {
  it('should return 200 for valid credentials', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        email: 'test@example.com',
        password: 'password123'
      }
    });

    await handler(req, res);

    expect(res._getStatusCode()).toBe(200);
    
    const responseData = JSON.parse(res._getData());
    expect(responseData.success).toBe(true);
    expect(responseData.data).toHaveProperty('token');
  });

  it('should return 400 for invalid credentials', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        email: 'test@example.com',
        password: 'wrongpassword'
      }
    });

    await handler(req, res);

    expect(res._getStatusCode()).toBe(400);
    
    const responseData = JSON.parse(res._getData());
    expect(responseData.success).toBe(false);
    expect(responseData.error.code).toBe('INVALID_CREDENTIALS');
  });
});
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
```typescript
// lib/query-optimizer.ts
export class QueryOptimizer {
  // ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
  static async findUserByReferralCode(referralCode: string) {
    return prisma.user.findUnique({
      where: { referralCode }, // å·²ç»åœ¨referralCodeå­—æ®µåˆ›å»ºäº†ç´¢å¼•
      select: {
        id: true,
        name: true,
        email: true
      }
    });
  }

  // ä½¿ç”¨explainåˆ†ææŸ¥è¯¢æ€§èƒ½
  static async analyzeQuery() {
    return prisma.$queryRaw`
      EXPLAIN ANALYZE
      SELECT u.*, COUNT(r.id) as referral_count
      FROM users u
      LEFT JOIN referral_relationships r ON u.id = r.referrer_id
      WHERE u.created_at >= NOW() - INTERVAL '30 days'
      GROUP BY u.id
      ORDER BY referral_count DESC
    `;
  }
}
```

### ç¼“å­˜ç­–ç•¥
```typescript
// lib/cache-strategy.ts
export class CacheStrategy {
  // ç”¨æˆ·æ•°æ®ç¼“å­˜
  static async getUserCached(userId: string) {
    const cacheKey = `user:${userId}`;
    const cached = await cacheManager.get(cacheKey);
    
    if (cached) {
      return cached;
    }

    const user = await prisma.user.findUnique({
      where: { id: userId }
    });

    // ç¼“å­˜30åˆ†é’Ÿ
    await cacheManager.set(cacheKey, user, 1800);
    
    return user;
  }

  // æ¨èç»Ÿè®¡ç¼“å­˜
  static async getReferralStatsCached(userId: string) {
    const cacheKey = `referral:stats:${userId}`;
    const cached = await cacheManager.get(cacheKey);
    
    if (cached) {
      return cached;
    }

    const stats = await this.calculateReferralStats(userId);
    
    // ç¼“å­˜10åˆ†é’Ÿ
    await cacheManager.set(cacheKey, stats, 600);
    
    return stats;
  }

  private static async calculateReferralStats(userId: string) {
    const relationships = await prisma.referralRelationship.findMany({
      where: { referrerId: userId },
      include: {
        referee: {
          select: {
            id: true,
            isActive: true,
            createdAt: true
          }
        }
      }
    });

    // è®¡ç®—ç»Ÿè®¡æ•°æ®
    return {
      totalReferrals: relationships.length,
      activeReferrals: relationships.filter(r => r.referee.isActive).length,
      levelDistribution: this.calculateLevelDistribution(relationships)
    };
  }
}
```

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–
```tsx
// components/LazyProductList.tsx
'use client';

import React, { useState, useCallback } from 'react';
import { useInfiniteQuery } from '@tanstack/react-query';

interface Product {
  id: string;
  name: string;
  price: number;
  image: string;
}

export const LazyProductList: React.FC = () => {
  const {
    data,
    hasNextPage,
    isFetchingNextPage,
    fetchNextPage
  } = useInfiniteQuery({
    queryKey: ['products'],
    queryFn: async ({ pageParam = 0 }) => {
      const response = await fetch(`/api/products?page=${pageParam}&limit=20`);
      return response.json();
    },
    getNextPageParam: (lastPage, pages) => {
      if (lastPage.hasMore) {
        return pages.length;
      }
      return undefined;
    },
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
  });

  const handleLoadMore = useCallback(() => {
    if (hasNextPage && !isFetchingNextPage) {
      fetchNextPage();
    }
  }, [hasNextPage, isFetchingNextPage, fetchNextPage]);

  return (
    <div className="product-list">
      {data?.pages.map((page, i) => (
        <React.Fragment key={i}>
          {page.data.products.map((product: Product) => (
            <div key={product.id} className="product-item">
              <img 
                src={product.image} 
                alt={product.name}
                loading="lazy"
                className="product-image"
              />
              <h3>{product.name}</h3>
              <p>${product.price}</p>
            </div>
          ))}
        </React.Fragment>
      ))}
      
      {hasNextPage && (
        <button 
          onClick={handleLoadMore}
          disabled={isFetchingNextPage}
          className="load-more-btn"
        >
          {isFetchingNextPage ? 'Loading...' : 'Load More'}
        </button>
      )}
    </div>
  );
};
```

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### APIå®‰å…¨
```typescript
// lib/middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function securityHeaders(request: NextRequest) {
  const response = NextResponse.next();
  
  // å®‰å…¨å¤´è®¾ç½®
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
  );
  
  return response;
}

export function rateLimit(request: NextRequest) {
  const ip = request.ip ?? '127.0.0.1';
  const key = `rate_limit:${ip}`;
  
  // Rediså®ç°é™æµé€»è¾‘
  // ...
}
```

### è¾“å…¥éªŒè¯
```typescript
// lib/validators.ts
import { z } from 'zod';

export const UserProfileSchema = z.object({
  name: z.string().min(2).max(50),
  phone: z.string().regex(/^\+?[1-9]\d{1,14}$/).optional(),
});

export const ReferralCodeSchema = z.object({
  code: z.string().length(6).regex(/^[A-Z0-9]+$/),
});

export const RewardRequestSchema = z.object({
  amount: z.number().positive().max(10000),
  bankInfo: z.object({
    bankName: z.string().min(2).max(100),
    accountNumber: z.string().regex(/^\d{12,19}$/),
    accountHolder: z.string().min(2).max(50),
  }),
});
```

### é˜²SQLæ³¨å…¥å’ŒN+1æŸ¥è¯¢
```typescript
// lib/anti-n-plus-one.ts
export class NPlusOneDetector {
  private static queryCount = 0;
  private static queries: Array<{ sql: string; timestamp: number }> = [];

  static enableMonitoring() {
    const originalQuery = prisma.$queryRaw;
    
    prisma.$queryRaw = (...args: any[]) => {
      this.queryCount++;
      this.queries.push({
        sql: args[0].toString(),
        timestamp: Date.now()
      });
      
      // æ£€æµ‹N+1æŸ¥è¯¢æ¨¡å¼
      this.detectNPlusOne();
      
      return originalQuery(...args);
    };
  }

  private static detectNPlusOne() {
    if (this.queries.length > 100) {
      const recentQueries = this.queries.slice(-50);
      const sqlPatterns = recentQueries.map(q => q.sql);
      
      // ç®€å•çš„N+1æ£€æµ‹ï¼šç»Ÿè®¡ç›¸åŒæ¨¡å¼çš„æŸ¥è¯¢
      const patternCount = sqlPatterns.reduce((acc, sql) => {
        const key = sql.replace(/\d+/g, '?');
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {} as Record<string, number>);
      
      const maxCount = Math.max(...Object.values(patternCount));
      
      if (maxCount > 10) {
        console.warn(`Potential N+1 query detected: ${maxCount} similar queries`);
      }
    }
  }
}
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—é…ç½®
```typescript
// lib/logger.ts
import winston from 'winston';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
  ],
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

export { logger };
```

### æ€§èƒ½ç›‘æ§
```typescript
// lib/monitoring.ts
export class PerformanceMonitor {
  static async measureApiCall<T>(
    operation: string,
    fn: () => Promise<T>
  ): Promise<T> {
    const startTime = Date.now();
    
    try {
      const result = await fn();
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      logger.info('API call completed', {
        operation,
        duration,
        status: 'success'
      });
      
      // è®°å½•æ…¢æŸ¥è¯¢
      if (duration > 5000) {
        logger.warn('Slow API call detected', {
          operation,
          duration
        });
      }
      
      return result;
    } catch (error) {
      const endTime = Date.now();
      const duration = endTime - startTime;
      
      logger.error('API call failed', {
        operation,
        duration,
        error: error.message,
        stack: error.stack
      });
      
      throw error;
    }
  }
}
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Dockeré…ç½®
```dockerfile
# Dockerfile
FROM node:20-alpine AS base

# å®‰è£…ä¾èµ–
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci --only=production

# æ„å»ºåº”ç”¨
FROM base AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules

RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000

CMD ["node", "server.js"]
```

### CI/CD Pipeline
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test:coverage
      
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm ci
      - run: npm run build
      
      - name: Build Docker image
        run: |
          docker build -t luckymart:latest .
          
      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push luckymart:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        run: |
          ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
            docker pull luckymart:latest
            docker-compose up -d
          '
```

## ğŸ“ å¼€å‘å·¥ä½œæµ

### Gitå·¥ä½œæµ
1. **Feature Branch**: ä»mainåˆ†æ”¯åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
2. **å¼€å‘**: åœ¨åŠŸèƒ½åˆ†æ”¯ä¸Šå¼€å‘
3. **æµ‹è¯•**: è¿è¡Œæ‰€æœ‰æµ‹è¯•ç¡®ä¿è´¨é‡
4. **ä»£ç å®¡æŸ¥**: åˆ›å»ºPull Request
5. **åˆå¹¶**: åˆå¹¶åˆ°mainåˆ†æ”¯

### æäº¤è§„èŒƒ
```
feat: æ·»åŠ ç”¨æˆ·æ¨èç»Ÿè®¡åŠŸèƒ½
fix: ä¿®å¤æ¨èç é‡å¤ç”Ÿæˆbug
docs: æ›´æ–°APIæ–‡æ¡£
style: æ ¼å¼åŒ–ä»£ç 
refactor: é‡æ„ç¼“å­˜ç®¡ç†å™¨
test: æ·»åŠ æ¨èç³»ç»Ÿæµ‹è¯•
chore: æ›´æ–°ä¾èµ–ç‰ˆæœ¬
```

### ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- [ ] æ·»åŠ å¿…è¦çš„æµ‹è¯•
- [ ] æ€§èƒ½å½±å“è¯„ä¼°
- [ ] å®‰å…¨é£é™©æ£€æŸ¥
- [ ] æ–‡æ¡£æ›´æ–°
- [ ] å‘åå…¼å®¹æ€§

## ğŸ“ å¼€å‘æ”¯æŒ

### å›¢é˜Ÿæ²Ÿé€š
- **Slacké¢‘é“**: #luckymart-dev
- **Telegramç¾¤**: @LuckymartDevTeam
- **æ–‡æ¡£åä½œ**: Confluence

### é—®é¢˜æŠ¥å‘Š
- **BugæŠ¥å‘Š**: GitHub Issues
- **åŠŸèƒ½è¯·æ±‚**: GitHub Discussions
- **å®‰å…¨æ¼æ´**: security@luckymart.com

### æŠ€æœ¯èµ„æº
- [Next.jsæ–‡æ¡£](https://nextjs.org/docs)
- [Prismaæ–‡æ¡£](https://www.prisma.io/docs)
- [Supabaseæ–‡æ¡£](https://supabase.com/docs)
- [React TypeScriptæŒ‡å—](https://react-typescript-cheatsheet.netlify.app/)

---

æ„Ÿè°¢æ‚¨ä¸ºLuckyMart-TJé¡¹ç›®è´¡çŒ®ä»£ç ï¼éµå¾ªè¿™äº›è§„èŒƒå°†ç¡®ä¿ä»£ç è´¨é‡å’Œé¡¹ç›®çš„é•¿æœŸå‘å±•ã€‚