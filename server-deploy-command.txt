#!/bin/bash

echo "🚀 开始服务器部署 LuckyMart TJ 移动端优化版本..."
echo "📅 部署时间: $(date)"
echo ""

# 1. 备份当前版本
echo "📁 1. 备份当前版本..."
BACKUP_DIR="/var/backups/luckymart-tj-$(date +%Y%m%d-%H%M%S)"
mkdir -p $BACKUP_DIR
if [ -d "/var/www/luckymart-tj" ]; then
    cp -r /var/www/luckymart-tj/* $BACKUP_DIR/ 2>/dev/null || true
    echo "✅ 备份完成: $BACKUP_DIR"
fi

# 2. 进入项目目录
echo "📂 2. 进入项目目录..."
cd /var/www/luckymart-tj

# 3. 拉取最新代码
echo "📥 3. 拉取GitHub最新代码..."
git pull origin main

# 4. 安装依赖
echo "🔧 4. 安装依赖..."
npm install

# 5. 数据库迁移
echo "🗄️ 5. 数据库迁移..."
npx prisma generate
npx prisma db push

# 6. 构建项目
echo "⚡ 6. 构建项目..."
npm run build

# 7. 重启服务
echo "🔄 7. 重启服务..."
pm2 restart luckymart-tj || pm2 start npm --name "luckymart-tj" -- start

# 8. 检查服务状态
echo "📊 8. 检查服务状态..."
pm2 status
systemctl status nginx --no-pager -l

# 9. 健康检查
echo "🔍 9. 健康检查..."
curl -f http://localhost:3000/health || echo "⚠️ 主站健康检查失败"
curl -f http://localhost:3000/api/monitoring/health || echo "⚠️ API健康检查失败"

echo ""
echo "🎉 部署完成！"
echo "📝 部署摘要:"
echo "   - 代码已更新到最新版本"
echo "   - 依赖已安装并构建"
echo "   - 数据库迁移完成"
echo "   - 服务已重启"
echo "   - 备份保存在: $BACKUP_DIR"
echo ""
echo "🔗 访问地址:"
echo "   - 网站: http://47.243.83.253:3000"
echo "   - 管理后台: http://47.243.83.253:3000/admin"
echo ""
echo "⚠️  如有问题，请检查:"
echo "   - PM2日志: pm2 logs"
echo "   - Nginx日志: tail -f /var/log/nginx/error.log"
echo "   - 系统日志: journalctl -u nginx"